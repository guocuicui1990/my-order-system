<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶è‡ªåŠ©æ³¨å†Œç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .register-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .register-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .register-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .register-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .register-stepper {
            display: flex;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            color: #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: #4CAF50;
            color: white;
        }
        
        .step.completed .step-number {
            background: #2E7D32;
            color: white;
        }
        
        .step-label {
            font-size: 12px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #4CAF50;
            font-weight: 600;
        }
        
        .form-content {
            padding: 30px;
            min-height: 500px;
        }
        
        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .form-step.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .form-group label.required::after {
            content: ' *';
            color: #f44336;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* èœå“ç®¡ç†åŒºåŸŸ */
        .dishes-management {
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .dish-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .dish-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .dish-item input[type="number"] {
            width: 100px;
        }
        
        .btn-add-dish {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .btn-remove-dish {
            background: #f44336;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* é…ç½®é¢„è§ˆ */
        .config-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .preview-item {
            margin-bottom: 5px;
            display: flex;
            gap: 10px;
        }
        
        .preview-key {
            color: #667eea;
            min-width: 120px;
        }
        
        .preview-value {
            color: #333;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2E7D32);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* æŒ‰é’®åŒºåŸŸ */
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-prev {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .btn-next {
            background: #2196F3;
            color: white;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 15px 30px;
            font-size: 16px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e0e0e0;
        }
        
        .status-dot.active {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* æˆåŠŸé¡µé¢ */
        .success-screen {
            text-align: center;
            padding: 50px 20px;
            display: none;
        }
        
        .success-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .success-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .config-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            text-align: left;
        }
        
        .config-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .config-label {
            color: #666;
        }
        
        .config-value {
            font-weight: 600;
            color: #333;
            font-family: monospace;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ–°å¢ï¼šé…ç½®ä¸‹è½½åŒºåŸŸæ ·å¼ */
        .config-download-area {
            background: #e8f5e9;
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .config-download-area h4 {
            color: #2E7D32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .config-download-area p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        /* æ–°å¢ï¼šæ‰‹åŠ¨é…ç½®è¯´æ˜å¼¹çª—æ ·å¼ */
        .manual-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .manual-config-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 100%;
        }
        
        .manual-config-title {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .manual-config-code {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .manual-config-steps {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .manual-config-steps ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .manual-config-steps li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <!-- æ³¨å†Œå¤´éƒ¨ -->
        <div class="register-header">
            <h1><i class="fas fa-store-plus"></i> å•†å®¶è‡ªåŠ©æ³¨å†Œç³»ç»Ÿ</h1>
            <p>åªéœ€5åˆ†é’Ÿï¼Œå¿«é€Ÿåˆ›å»ºæ‚¨çš„ä¸“å±ç‚¹é¤ç³»ç»Ÿ</p>
        </div>
        
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="register-stepper">
            <div class="step completed" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">åŸºæœ¬ä¿¡æ¯</div>
            </div>
            <div class="step active" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">èœå“é…ç½®</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">æ”¶æ¬¾è®¾ç½®</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-label">ç³»ç»Ÿé…ç½®</div>
            </div>
        </div>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 25%"></div>
        </div>
        
        <!-- è¡¨å•å†…å®¹ -->
        <div class="form-content">
            <!-- æ­¥éª¤1: åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-step active" id="stepForm1">
                <h2 style="margin-bottom: 20px; color: #333;">åŸºæœ¬ä¿¡æ¯è®¾ç½®</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">å•†å®¶åç§°</label>
                        <input type="text" class="form-control" id="shopName" placeholder="ä¾‹å¦‚ï¼šè€ç‹ç…é¥¼" maxlength="20">
                        <div class="status-indicator">
                            <div class="status-dot active"></div>
                            <span>åç§°å°†æ˜¾ç¤ºåœ¨é¡¾å®¢ç«¯å’Œåå°</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å•†å®¶ç®€ç§°ï¼ˆè‹±æ–‡/æ‹¼éŸ³ï¼‰</label>
                        <input type="text" class="form-control" id="shopSlug" placeholder="ä¾‹å¦‚ï¼šlaowang" maxlength="20">
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <span>ç”¨äºç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼Œå»ºè®®ä½¿ç”¨æ‹¼éŸ³</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">è”ç³»äººå§“å</label>
                        <input type="text" class="form-control" id="contactName" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">è”ç³»ç”µè¯</label>
                        <input type="tel" class="form-control" id="contactPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " pattern="[0-9]{11}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>é‚®ç®±åœ°å€</label>
                        <input type="email" class="form-control" id="contactEmail" placeholder="ç”¨äºæ¥æ”¶è®¢å•é€šçŸ¥">
                    </div>
                    
                    <div class="form-group">
                        <label>å•†å®¶ç±»å‹</label>
                        <select class="form-control" id="shopType">
                            <option value="food">é¤é¥®å°åƒ</option>
                            <option value="drink">é¥®å“å¥¶èŒ¶</option>
                            <option value="snack">é›¶é£Ÿç”œå“</option>
                            <option value="other">å…¶ä»–ç±»å‹</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å•†å®¶æè¿°</label>
                    <textarea class="form-control" id="shopDescription" rows="3" placeholder="ç®€å•æè¿°æ‚¨çš„åº—é“ºç‰¹è‰²..." maxlength="200"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ä¸»é¢˜é¢œè‰²</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="themeColor" value="#E63946" style="width: 50px; height: 40px;">
                        <input type="text" class="form-control" id="themeColorText" value="#E63946" style="flex: 1;">
                        <button type="button" onclick="resetThemeColor()" style="padding: 8px 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2: èœå“é…ç½® -->
            <div class="form-step" id="stepForm2">
                <h2 style="margin-bottom: 20px; color: #333;">èœå“ç®¡ç†</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">æ·»åŠ æ‚¨çš„æ‹›ç‰Œèœå“ï¼Œé¡¾å®¢å°†åœ¨è¿™é‡Œé€‰æ‹©</p>
                
                <div class="dishes-management">
                    <div id="dishesList">
                        <!-- åŠ¨æ€æ·»åŠ çš„èœå“é¡¹ -->
                        <div class="dish-item">
                            <input type="text" class="dish-name" placeholder="èœå“åç§°" value="æ‹›ç‰Œç‚¸é…±é¢">
                            <input type="number" class="dish-price" placeholder="ä»·æ ¼" value="15" min="0" step="0.01">
                            <select class="dish-category">
                                <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                                <option value="çƒ­èœ">çƒ­èœ</option>
                                <option value="å°åƒ">å°åƒ</option>
                                <option value="å‡‰èœ">å‡‰èœ</option>
                                <option value="é¥®æ–™">é¥®æ–™</option>
                            </select>
                            <input type="text" class="dish-emoji" placeholder="å›¾æ ‡" value="ğŸœ" maxlength="2">
                            <button type="button" class="btn-remove-dish" onclick="removeDish(this)" disabled>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="dish-item">
                            <input type="text" class="dish-name" placeholder="èœå“åç§°" value="éº»è¾£çƒ«å¥—é¤">
                            <input type="number" class="dish-price" placeholder="ä»·æ ¼" value="18" min="0" step="0.01">
                            <select class="dish-category">
                                <option value="çƒ­èœ">çƒ­èœ</option>
                                <option value="ä¸»é£Ÿ" selected>ä¸»é£Ÿ</option>
                                <option value="å°åƒ">å°åƒ</option>
                                <option value="å‡‰èœ">å‡‰èœ</option>
                                <option value="é¥®æ–™">é¥®æ–™</option>
                            </select>
                            <input type="text" class="dish-emoji" placeholder="å›¾æ ‡" value="ğŸ¥˜" maxlength="2">
                            <button type="button" class="btn-remove-dish" onclick="removeDish(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-dish" onclick="addDish()">
                        <i class="fas fa-plus"></i> æ·»åŠ èœå“
                    </button>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>é»˜è®¤æ¨èèœå“</label>
                    <select class="form-control" id="recommendDishes" multiple style="height: 120px;">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </select>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        æŒ‰ä½Ctrlé”®å¯é€‰æ‹©å¤šä¸ªèœå“ä½œä¸ºé»˜è®¤æ¨è
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤3: æ”¶æ¬¾è®¾ç½® -->
            <div class="form-step" id="stepForm3">
                <h2 style="margin-bottom: 20px; color: #333;">æ”¶æ¬¾è®¾ç½®</h2>
                
                <div class="form-group">
                    <label class="required">å¾®ä¿¡æ”¶æ¬¾ç </label>
                    <div style="border: 2px dashed #e0e0e0; border-radius: 10px; padding: 20px; text-align: center;">
                        <div id="wechatUploadArea" style="cursor: pointer;">
                            <i class="fas fa-qrcode" style="font-size: 40px; color: #07C160; margin-bottom: 10px;"></i>
                            <p style="color: #666; margin-bottom: 10px;">ç‚¹å‡»ä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç å›¾ç‰‡</p>
                            <p style="font-size: 12px; color: #999;">å»ºè®®å°ºå¯¸ï¼š300Ã—300åƒç´ ï¼Œæ”¯æŒ JPG/PNG æ ¼å¼</p>
                        </div>
                        <input type="file" id="wechatQR" accept="image/*" style="display: none;" onchange="previewQRImage(this, 'wechat')">
                        <div id="wechatPreview" style="display: none; margin-top: 15px;">
                            <img id="wechatPreviewImg" style="max-width: 200px; border-radius: 8px;">
                            <button type="button" onclick="removeQRImage('wechat')" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç§»é™¤
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ”¯ä»˜å®æ”¶æ¬¾ç </label>
                    <div style="border: 2px dashed #e0e0e0; border-radius: 10px; padding: 20px; text-align: center;">
                        <div id="alipayUploadArea" style="cursor: pointer;">
                            <i class="fas fa-qrcode" style="font-size: 40px; color: #00A0E9; margin-bottom: 10px;"></i>
                            <p style="color: #666; margin-bottom: 10px;">ç‚¹å‡»ä¸Šä¼ æ”¯ä»˜å®æ”¶æ¬¾ç å›¾ç‰‡</p>
                            <p style="font-size: 12px; color: #999;">å»ºè®®å°ºå¯¸ï¼š300Ã—300åƒç´ ï¼Œæ”¯æŒ JPG/PNG æ ¼å¼</p>
                        </div>
                        <input type="file" id="alipayQR" accept="image/*" style="display: none;" onchange="previewQRImage(this, 'alipay')">
                        <div id="alipayPreview" style="display: none; margin-top: 15px;">
                            <img id="alipayPreviewImg" style="max-width: 200px; border-radius: 8px;">
                            <button type="button" onclick="removeQRImage('alipay')" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                ç§»é™¤
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æ”¶æ¬¾å¤‡æ³¨</label>
                    <textarea class="form-control" id="paymentNote" rows="2" placeholder="ä¾‹å¦‚ï¼šä»˜æ¬¾æ—¶è¯·å¤‡æ³¨å–é¤å·"></textarea>
                </div>
            </div>
            
            <!-- æ­¥éª¤4: ç³»ç»Ÿé…ç½® -->
            <div class="form-step" id="stepForm4">
                <h2 style="margin-bottom: 20px; color: #333;">ç³»ç»Ÿé…ç½®é¢„è§ˆ</h2>
                
                <div class="config-preview" id="configPreview">
                    <div class="preview-item">
                        <span class="preview-key">å•†å®¶ID:</span>
                        <span class="preview-value" id="previewShopId">ç”Ÿæˆä¸­...</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">å•†å®¶åç§°:</span>
                        <span class="preview-value" id="previewShopName">-</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">è”ç³»äºº:</span>
                        <span class="preview-value" id="previewContact">-</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">èœå“æ•°é‡:</span>
                        <span class="preview-value" id="previewDishCount">0</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">ä¸»é¢˜é¢œè‰²:</span>
                        <span class="preview-value" id="previewThemeColor">#E63946</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">å–é¤ç å‰ç¼€:</span>
                        <span class="preview-value" id="previewSequencePrefix">A</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">åå°é“¾æ¥:</span>
                        <span class="preview-value" id="previewAdminLink">-</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-key">é¡¾å®¢ç«¯é“¾æ¥:</span>
                        <span class="preview-value" id="previewCustomerLink">-</span>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="acceptTerms" checked>
                        æˆ‘åŒæ„å¹¶æ¥å—
                        <a href="#" style="color: #2196F3;">ã€ŠæœåŠ¡æ¡æ¬¾ã€‹</a>
                        å’Œ
                        <a href="#" style="color: #2196F3;">ã€Šéšç§æ”¿ç­–ã€‹</a>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableMonitoring" checked>
                        å¯ç”¨ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦ï¼ˆæ¨èï¼‰
                    </label>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ç›‘æ§ç³»ç»Ÿå°†å®æ—¶ç›‘æµ‹æ‚¨çš„è®¢å•çŠ¶æ€ã€ç³»ç»Ÿè¿æ¥ç­‰ï¼Œå¹¶åœ¨å¼‚å¸¸æ—¶å‘é€å‘Šè­¦
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ç®¡ç†å¯†ç </label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="password" class="form-control" id="adminPassword" placeholder="è®¾ç½®åå°ç®¡ç†å¯†ç " minlength="6">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="confirmPassword" placeholder="ç¡®è®¤å¯†ç " minlength="6">
                        </div>
                    </div>
                </div>
                
                <div class="status-indicator" id="configStatus">
                    <div class="status-dot active"></div>
                    <span>æ­£åœ¨éªŒè¯é…ç½®...</span>
                </div>
            </div>
            
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="form-actions">
                <button type="button" class="btn btn-prev" onclick="prevStep()" id="prevBtn" style="display: none;">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-next" onclick="nextStep()" id="nextBtn">
                    ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- æˆåŠŸé¡µé¢ï¼ˆæ³¨å†Œå®Œæˆåæ˜¾ç¤ºï¼‰ -->
        <div class="success-screen" id="successScreen">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title">æ³¨å†ŒæˆåŠŸï¼</h2>
            <p style="color: #666; margin-bottom: 30px; max-width: 500px; margin: 0 auto 30px;">
                æ‚¨çš„ç‚¹é¤ç³»ç»Ÿå·²åˆ›å»ºå®Œæˆï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼š
            </p>
            
            <div class="config-details">
                <div class="config-item">
                    <span class="config-label">å•†å®¶IDï¼š</span>
                    <span class="config-value" id="finalShopId">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">å•†å®¶åç§°ï¼š</span>
                    <span class="config-value" id="finalShopName">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">åå°ç®¡ç†ï¼š</span>
                    <span class="config-value">
                        <a href="#" id="finalAdminLink" target="_blank" style="color: #2196F3;">ç‚¹å‡»è¿›å…¥</a>
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">é¡¾å®¢ç‚¹é¤ï¼š</span>
                    <span class="config-value">
                        <a href="#" id="finalCustomerLink" target="_blank" style="color: #2196F3;">ç‚¹å‡»è®¿é—®</a>
                    </span>
                </div>
                <div class="config-item">
                    <span class="config-label">ç®¡ç†å¯†ç ï¼š</span>
                    <span class="config-value" id="finalPassword">-</span>
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šé…ç½®æ–‡ä»¶ä¸‹è½½åŒºåŸŸ -->
            <div class="config-download-area" id="configDownloadArea" style="display: none;">
                <h4><i class="fas fa-file-download"></i> é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ</h4>
                <p>è¯·ä¸‹è½½æ›´æ–°åçš„é…ç½®æ–‡ä»¶å¹¶æ›¿æ¢é¡¹ç›®ä¸­çš„ config.js æ–‡ä»¶ï¼Œè¿™æ ·æ–°æ³¨å†Œçš„å•†å®¶æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚</p>
                <button class="btn" onclick="downloadUpdatedConfig()" style="background: #2196F3;">
                    <i class="fas fa-download"></i> ä¸‹è½½é…ç½®æ–‡ä»¶
                </button>
                <button class="btn" onclick="showManualConfigInstructions()" style="background: #ff9800; margin-left: 10px;">
                    <i class="fas fa-question-circle"></i> æŸ¥çœ‹æ‰‹åŠ¨é…ç½®è¯´æ˜
                </button>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="openAdminPanel()" style="background: #4CAF50;">
                    <i class="fas fa-chart-line"></i> è¿›å…¥å•†å®¶åå°
                </button>
                <button class="btn" onclick="showQRCode()" style="background: #9C27B0;">
                    <i class="fas fa-qrcode"></i> ç”Ÿæˆé¡¾å®¢äºŒç»´ç 
                </button>
                <button class="btn" onclick="startNewRegistration()" style="background: #607D8B;">
                    <i class="fas fa-plus"></i> æ³¨å†Œæ–°å•†å®¶
                </button>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
                <p><strong>é‡è¦æç¤ºï¼š</strong>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„å•†å®¶IDå’Œç®¡ç†å¯†ç ï¼Œè¿™æ˜¯æ‚¨ç®¡ç†ç³»ç»Ÿçš„å”¯ä¸€å‡­è¯ã€‚</p>
                <p>ç³»ç»Ÿå·²è‡ªåŠ¨é…ç½®Supabaseæ•°æ®åº“ï¼Œæ‚¨å¯ä»¥åœ¨å•†å®¶åå°æŸ¥çœ‹å®æ—¶è®¢å•æ•°æ®ã€‚</p>
                <p id="configStatusMessage" style="color: #4CAF50; margin-top: 5px;">æœ¬åœ°é…ç½®å·²æ›´æ–°ï¼Œæ–°å•†å®¶å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <!-- å¼•å…¥Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // å…¨å±€å˜é‡å’Œé…ç½®
        // ============================================
        const SUPABASE_URL = 'https://slonbvmhsxqgpoodwazj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb25idm1oc3hxZ3Bvb2R3YXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzMyNjQsImV4cCI6MjA4NDYwOTI2NH0.YLZqdnZl1vDTOrT6bzi2ulN1BGRxKGyW30AuccuWJq4';
        
        let currentStep = 1;
        let totalSteps = 4;
        let shopConfig = {
            id: '',
            name: '',
            slug: '',
            contact: {},
            themeColor: '#E63946',
            dishes: [],
            qrCodes: {},
            settings: {},
            createdAt: new Date().toISOString()
        };
        
        let supabaseClient = null;
        let generatedShopId = '';
        let updatedConfigJS = null; // å­˜å‚¨æ›´æ–°åçš„é…ç½®æ–‡ä»¶
        
        // ============================================
        // åˆå§‹åŒ–å‡½æ•°
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å•†å®¶è‡ªåŠ©æ³¨å†Œç³»ç»Ÿåˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // ç»‘å®šäº‹ä»¶
            initEventListeners();
            
            // åˆå§‹åŒ–èœå“æ¨èé€‰æ‹©
            updateRecommendSelect();
            
            // æ›´æ–°é¢„è§ˆ
            updateConfigPreview();
            
            console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
        });
        
        function initEventListeners() {
            // å•†å®¶åç§°è¾“å…¥æ—¶è‡ªåŠ¨ç”Ÿæˆç®€ç§°
            document.getElementById('shopName').addEventListener('input', function() {
                const name = this.value.trim();
                const slugInput = document.getElementById('shopSlug');
                
                if (name && !slugInput.value) {
                    // è½¬æ¢ä¸ºæ‹¼éŸ³ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”ä½¿ç”¨æ‹¼éŸ³åº“ï¼‰
                    const slug = convertToSlug(name);
                    slugInput.value = slug;
                }
                
                updateConfigPreview();
            });
            
            // ä¸»é¢˜é¢œè‰²åŒæ­¥
            document.getElementById('themeColor').addEventListener('input', function() {
                document.getElementById('themeColorText').value = this.value;
                shopConfig.themeColor = this.value;
                updateConfigPreview();
            });
            
            document.getElementById('themeColorText').addEventListener('input', function() {
                const color = this.value;
                if (/^#[0-9A-F]{6}$/i.test(color)) {
                    document.getElementById('themeColor').value = color;
                    shopConfig.themeColor = color;
                }
                updateConfigPreview();
            });
            
            // è”ç³»äººä¿¡æ¯æ›´æ–°
            document.getElementById('contactName').addEventListener('input', updateConfigPreview);
            document.getElementById('contactPhone').addEventListener('input', updateConfigPreview);
            document.getElementById('contactEmail').addEventListener('input', updateConfigPreview);
            
            // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            document.getElementById('wechatUploadArea').addEventListener('click', function() {
                document.getElementById('wechatQR').click();
            });
            
            document.getElementById('alipayUploadArea').addEventListener('click', function() {
                document.getElementById('alipayQR').click();
            });
            
            // å¯†ç éªŒè¯
            document.getElementById('confirmPassword').addEventListener('input', function() {
                const password = document.getElementById('adminPassword').value;
                const confirm = this.value;
                
                if (password && confirm && password !== confirm) {
                    this.style.borderColor = '#f44336';
                    document.getElementById('adminPassword').style.borderColor = '#f44336';
                } else {
                    this.style.borderColor = '#e0e0e0';
                    document.getElementById('adminPassword').style.borderColor = '#e0e0e0';
                }
            });
            
            // æ¥å—æ¡æ¬¾
            document.getElementById('acceptTerms').addEventListener('change', function() {
                updateConfigPreview();
            });
            
            // ç›‘æ§å¼€å…³
            document.getElementById('enableMonitoring').addEventListener('change', function() {
                updateConfigPreview();
            });
        }
        
        // ============================================
        // æ­¥éª¤å¯¼èˆªå‡½æ•°
        // ============================================
        function nextStep() {
            // éªŒè¯å½“å‰æ­¥éª¤
            if (!validateCurrentStep()) {
                return;
            }
            
            // ä¿å­˜å½“å‰æ­¥éª¤æ•°æ®
            saveStepData(currentStep);
            
            if (currentStep < totalSteps) {
                // åˆ‡æ¢åˆ°ä¸‹ä¸€æ­¥
                document.getElementById(`stepForm${currentStep}`).classList.remove('active');
                document.getElementById(`step${currentStep}`).classList.remove('active');
                
                currentStep++;
                
                document.getElementById(`stepForm${currentStep}`).classList.add('active');
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = (currentStep / totalSteps) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                document.getElementById('prevBtn').style.display = 'inline-flex';
                
                if (currentStep === totalSteps) {
                    document.getElementById('nextBtn').innerHTML = 'æäº¤æ³¨å†Œ <i class="fas fa-check"></i>';
                    document.getElementById('nextBtn').className = 'btn btn-submit';
                    document.getElementById('nextBtn').onclick = submitRegistration;
                } else {
                    document.getElementById('nextBtn').innerHTML = 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>';
                    document.getElementById('nextBtn').className = 'btn btn-next';
                    document.getElementById('nextBtn').onclick = nextStep;
                }
                
                // å¦‚æœæ˜¯æœ€åä¸€æ­¥ï¼Œæ›´æ–°é¢„è§ˆ
                if (currentStep === totalSteps) {
                    updateConfigPreview();
                }
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                // ä¿å­˜å½“å‰æ­¥éª¤æ•°æ®
                saveStepData(currentStep);
                
                // åˆ‡æ¢åˆ°ä¸Šä¸€æ­¥
                document.getElementById(`stepForm${currentStep}`).classList.remove('active');
                document.getElementById(`step${currentStep}`).classList.remove('active');
                
                currentStep--;
                
                document.getElementById(`stepForm${currentStep}`).classList.add('active');
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = (currentStep / totalSteps) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                
                // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                if (currentStep === 1) {
                    document.getElementById('prevBtn').style.display = 'none';
                }
                
                document.getElementById('nextBtn').innerHTML = 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>';
                document.getElementById('nextBtn').className = 'btn btn-next';
                document.getElementById('nextBtn').onclick = nextStep;
            }
        }
        
        // ============================================
        // æ­¥éª¤éªŒè¯å‡½æ•°
        // ============================================
        function validateCurrentStep() {
            switch (currentStep) {
                case 1: // åŸºæœ¬ä¿¡æ¯
                    const shopName = document.getElementById('shopName').value.trim();
                    const contactName = document.getElementById('contactName').value.trim();
                    const contactPhone = document.getElementById('contactPhone').value.trim();
                    
                    if (!shopName) {
                        alert('è¯·è¾“å…¥å•†å®¶åç§°');
                        document.getElementById('shopName').focus();
                        return false;
                    }
                    
                    if (!contactName) {
                        alert('è¯·è¾“å…¥è”ç³»äººå§“å');
                        document.getElementById('contactName').focus();
                        return false;
                    }
                    
                    if (!contactPhone || !/^1[3-9]\d{9}$/.test(contactPhone)) {
                        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
                        document.getElementById('contactPhone').focus();
                        return false;
                    }
                    
                    return true;
                    
                case 2: // èœå“é…ç½®
                    const dishes = getDishesData();
                    if (dishes.length === 0) {
                        alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªèœå“');
                        return false;
                    }
                    
                    // æ£€æŸ¥èœå“åç§°å’Œä»·æ ¼
                    for (let i = 0; i < dishes.length; i++) {
                        const dish = dishes[i];
                        if (!dish.name || !dish.price) {
                            alert(`ç¬¬${i + 1}ä¸ªèœå“ä¿¡æ¯ä¸å®Œæ•´`);
                            return false;
                        }
                    }
                    
                    return true;
                    
                case 3: // æ”¶æ¬¾è®¾ç½®
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ”¶æ¬¾ç 
                    const wechatFile = document.getElementById('wechatQR').files[0];
                    const alipayFile = document.getElementById('alipayQR').files[0];
                    
                    if (!wechatFile && !alipayFile) {
                        if (!confirm('æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ”¶æ¬¾ç ï¼Œé¡¾å®¢å°†æ— æ³•ä»˜æ¬¾ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                            return false;
                        }
                    }
                    
                    return true;
                    
                case 4: // ç³»ç»Ÿé…ç½®
                    const acceptTerms = document.getElementById('acceptTerms').checked;
                    if (!acceptTerms) {
                        alert('è¯·æ¥å—æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–');
                        return false;
                    }
                    
                    const password = document.getElementById('adminPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (!password || password.length < 6) {
                        alert('è¯·è®¾ç½®è‡³å°‘6ä½æ•°çš„ç®¡ç†å¯†ç ');
                        document.getElementById('adminPassword').focus();
                        return false;
                    }
                    
                    if (password !== confirmPassword) {
                        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                        document.getElementById('confirmPassword').focus();
                        return false;
                    }
                    
                    return true;
                    
                default:
                    return true;
            }
        }
        
        // ============================================
        // æ•°æ®ä¿å­˜å‡½æ•°
        // ============================================
        function saveStepData(step) {
            switch (step) {
                case 1:
                    shopConfig.name = document.getElementById('shopName').value.trim();
                    shopConfig.slug = document.getElementById('shopSlug').value.trim() || 
                                     convertToSlug(shopConfig.name);
                    shopConfig.contact = {
                        name: document.getElementById('contactName').value.trim(),
                        phone: document.getElementById('contactPhone').value.trim(),
                        email: document.getElementById('contactEmail').value.trim(),
                    };
                    shopConfig.description = document.getElementById('shopDescription').value.trim();
                    shopConfig.type = document.getElementById('shopType').value;
                    shopConfig.themeColor = document.getElementById('themeColor').value;
                    break;
                    
                case 2:
                    shopConfig.dishes = getDishesData();
                    shopConfig.recommendDishes = Array.from(
                        document.getElementById('recommendDishes').selectedOptions
                    ).map(option => option.value);
                    break;
                    
                case 3:
                    // æ–‡ä»¶å°†åœ¨æäº¤æ—¶å¤„ç†
                    break;
                    
                case 4:
                    shopConfig.password = document.getElementById('adminPassword').value;
                    shopConfig.enableMonitoring = document.getElementById('enableMonitoring').checked;
                    break;
            }
        }
        
        // ============================================
        // èœå“ç®¡ç†å‡½æ•°
        // ============================================
        function addDish() {
            const dishesList = document.getElementById('dishesList');
            const dishItem = document.createElement('div');
            dishItem.className = 'dish-item';
            dishItem.innerHTML = `
                <input type="text" class="dish-name" placeholder="èœå“åç§°">
                <input type="number" class="dish-price" placeholder="ä»·æ ¼" min="0" step="0.01" value="10">
                <select class="dish-category">
                    <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                    <option value="çƒ­èœ">çƒ­èœ</option>
                    <option value="å°åƒ" selected>å°åƒ</option>
                    <option value="å‡‰èœ">å‡‰èœ</option>
                    <option value="é¥®æ–™">é¥®æ–™</option>
                </select>
                <input type="text" class="dish-emoji" placeholder="å›¾æ ‡" value="ğŸœ" maxlength="2">
                <button type="button" class="btn-remove-dish" onclick="removeDish(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            dishesList.appendChild(dishItem);
            
            // æ›´æ–°æ¨èé€‰æ‹©
            updateRecommendSelect();
            
            // ä¸ºæ–°å¢çš„èœå“è¾“å…¥æ¡†ç»‘å®šäº‹ä»¶
            const inputs = dishItem.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', updateConfigPreview);
            });
        }
        
        function removeDish(button) {
            const dishItem = button.closest('.dish-item');
            const dishesList = document.getElementById('dishesList');
            
            if (dishesList.children.length > 1) {
                dishItem.remove();
                updateRecommendSelect();
                updateConfigPreview();
            }
        }
        
        function getDishesData() {
            const dishes = [];
            const dishItems = document.querySelectorAll('.dish-item');
            
            dishItems.forEach((item, index) => {
                const name = item.querySelector('.dish-name').value.trim();
                const price = parseFloat(item.querySelector('.dish-price').value);
                const category = item.querySelector('.dish-category').value;
                const emoji = item.querySelector('.dish-emoji').value.trim();
                
                if (name && !isNaN(price)) {
                    dishes.push({
                        id: index + 1,
                        name: name,
                        price: price,
                        category: category,
                        emoji: emoji || 'ğŸ½ï¸',
                        tags: []
                    });
                }
            });
            
            return dishes;
        }
        
        function updateRecommendSelect() {
            const select = document.getElementById('recommendDishes');
            const dishes = getDishesData();
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value);
            
            // æ¸…ç©ºé€‰é¡¹
            select.innerHTML = '';
            
            // æ·»åŠ æ–°é€‰é¡¹
            dishes.forEach((dish, index) => {
                const option = document.createElement('option');
                option.value = dish.id;
                option.textContent = `${dish.name} - Â¥${dish.price}`;
                
                // å¦‚æœæ˜¯å‰ä¸¤ä¸ªèœå“ï¼Œé»˜è®¤é€‰ä¸­
                if (index < 2 || selectedValues.includes(dish.id.toString())) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        }
        
        // ============================================
        // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
        // ============================================
        function previewQRImage(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.match('image.*')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.getElementById(`${type}Preview`);
                const previewImg = document.getElementById(`${type}PreviewImg`);
                const uploadArea = document.getElementById(`${type}UploadArea`);
                
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
                uploadArea.style.display = 'none';
                
                // ä¿å­˜åˆ°é…ç½®
                shopConfig.qrCodes = shopConfig.qrCodes || {};
                shopConfig.qrCodes[type] = {
                    fileName: file.name,
                    dataUrl: e.target.result,
                    uploaded: false
                };
                
                updateConfigPreview();
            };
            
            reader.readAsDataURL(file);
        }
        
        function removeQRImage(type) {
            const previewDiv = document.getElementById(`${type}Preview`);
            const uploadArea = document.getElementById(`${type}UploadArea`);
            const fileInput = document.getElementById(`${type}QR`);
            
            previewDiv.style.display = 'none';
            uploadArea.style.display = 'block';
            fileInput.value = '';
            
            // ä»é…ç½®ä¸­ç§»é™¤
            if (shopConfig.qrCodes && shopConfig.qrCodes[type]) {
                delete shopConfig.qrCodes[type];
            }
            
            updateConfigPreview();
        }
        
        // ============================================
        // é…ç½®é¢„è§ˆæ›´æ–°
        // ============================================
        function updateConfigPreview() {
            // ä¿å­˜å½“å‰æ­¥éª¤æ•°æ®
            saveStepData(currentStep);
            
            // ç”Ÿæˆå•†å®¶IDï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!generatedShopId) {
                generatedShopId = generateShopId();
            }
            
            // æ›´æ–°é¢„è§ˆæ˜¾ç¤º
            document.getElementById('previewShopId').textContent = generatedShopId;
            document.getElementById('previewShopName').textContent = shopConfig.name || '-';
            document.getElementById('previewContact').textContent = shopConfig.contact ? 
                `${shopConfig.contact.name} (${shopConfig.contact.phone})` : '-';
            document.getElementById('previewDishCount').textContent = shopConfig.dishes ? shopConfig.dishes.length : 0;
            document.getElementById('previewThemeColor').textContent = shopConfig.themeColor || '#E63946';
            document.getElementById('previewSequencePrefix').textContent = getSequencePrefix();
            
            // ç”Ÿæˆé“¾æ¥é¢„è§ˆ - ä½¿ç”¨ç›¸å¯¹è·¯å¾„
            document.getElementById('previewAdminLink').textContent = 
                `admin.html?shop=${generatedShopId}`;
            document.getElementById('previewCustomerLink').textContent = 
                `index.html?shop=${generatedShopId}`;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusDot = document.querySelector('#configStatus .status-dot');
            const statusText = document.querySelector('#configStatus span');
            
            if (validateConfig()) {
                statusDot.style.background = '#4CAF50';
                statusText.textContent = 'é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥æäº¤æ³¨å†Œ';
            } else {
                statusDot.style.background = '#ff9800';
                statusText.textContent = 'é…ç½®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥';
            }
        }
        
        function getSequencePrefix() {
            return 'A';
        }
        
        function generateShopId() {
            // ç”Ÿæˆå”¯ä¸€å•†å®¶IDï¼šæ—¶é—´æˆ³ + éšæœºæ•° + åç§°ç¼©å†™
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 4);
            const slug = shopConfig.slug ? shopConfig.slug.substr(0, 3) : 'shop';
            
            return `${slug}_${timestamp}${random}`.toLowerCase();
        }
        
        function validateConfig() {
            return shopConfig.name && 
                   shopConfig.contact && 
                   shopConfig.contact.name && 
                   shopConfig.contact.phone && 
                   shopConfig.dishes && 
                   shopConfig.dishes.length > 0 &&
                   document.getElementById('acceptTerms').checked;
        }
        
        // ============================================
        // æäº¤æ³¨å†Œå‡½æ•°ï¼ˆæ ¸å¿ƒï¼‰
        // ============================================
        async function submitRegistration() {
            console.log('ğŸ“¤ æäº¤å•†å®¶æ³¨å†Œ...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('nextBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æäº¤...';
            document.getElementById('nextBtn').disabled = true;
            
            try {
                // 1. éªŒè¯é…ç½®
                if (!validateConfig()) {
                    throw new Error('é…ç½®ä¿¡æ¯ä¸å®Œæ•´');
                }
                
                // 2. ç”Ÿæˆæœ€ç»ˆå•†å®¶ID
                generatedShopId = generateShopId();
                shopConfig.id = generatedShopId;
                shopConfig.createdAt = new Date().toISOString();
                
                // 3. ä¸Šä¼ å›¾ç‰‡åˆ°Supabaseå­˜å‚¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                await uploadQRImages();
                
                // 4. åˆ›å»ºå•†å®¶è®°å½•ï¼ˆå†™å…¥Supabaseï¼‰
                await createShopInSupabase();
                
                // 5. åˆå§‹åŒ–å•†å®¶è®¾ç½®
                await initializeShopSettings();
                
                // 6. åˆ›å»ºèœå“æ•°æ®
                await createDishesInSupabase();
                
                // 7. åˆ›å»ºæ¨èèœå“ï¼ˆå¦‚æœæœ‰ï¼‰
                await createRecommendations();
                
                // 8. åˆ›å»ºç›‘æ§é…ç½®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (shopConfig.enableMonitoring) {
                    await createMonitoringConfig();
                }
                
                // 9. æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆconfig.jsï¼‰å¹¶ä¿å­˜åˆ°æœ¬åœ°
                await updateGlobalConfig();
                
                // 10. æ˜¾ç¤ºæˆåŠŸé¡µé¢
                showSuccessScreen();
                
                console.log('âœ… å•†å®¶æ³¨å†ŒæˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ æ³¨å†Œå¤±è´¥:', error);
                alert(`æ³¨å†Œå¤±è´¥: ${error.message}`);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.getElementById('nextBtn').innerHTML = 'æäº¤æ³¨å†Œ <i class="fas fa-check"></i>';
                document.getElementById('nextBtn').disabled = false;
            }
        }
        
        async function uploadQRImages() {
            if (!shopConfig.qrCodes || Object.keys(shopConfig.qrCodes).length === 0) {
                console.log('ğŸ“ æœªä¸Šä¼ æ”¶æ¬¾ç ï¼Œè·³è¿‡å›¾ç‰‡ä¸Šä¼ ');
                return;
            }
            
            console.log('ğŸ“¤ å¼€å§‹ä¸Šä¼ æ”¶æ¬¾ç å›¾ç‰‡...');
            
            for (const [type, qrData] of Object.entries(shopConfig.qrCodes)) {
                try {
                    // å°†DataURLè½¬æ¢ä¸ºBlob
                    const blob = dataURLtoBlob(qrData.dataUrl);
                    
                    // åˆ›å»ºæ–‡ä»¶å
                    const fileName = `${generatedShopId}_${type}_qrcode_${Date.now()}.png`;
                    
                    // ä¸Šä¼ åˆ°Supabaseå­˜å‚¨
                    const { data, error } = await supabaseClient.storage
                        .from('shop-qrcodes')
                        .upload(fileName, blob, {
                            contentType: 'image/png',
                            upsert: true
                        });
                    
                    if (error) throw error;
                    
                    console.log(`âœ… ${type}æ”¶æ¬¾ç ä¸Šä¼ æˆåŠŸ:`, data);
                    
                    // æ›´æ–°é…ç½®ä¸­çš„å›¾ç‰‡URL
                    const { data: urlData } = supabaseClient.storage
                        .from('shop-qrcodes')
                        .getPublicUrl(fileName);
                    
                    shopConfig.qrCodes[type].url = urlData.publicUrl;
                    shopConfig.qrCodes[type].uploaded = true;
                    
                } catch (error) {
                    console.warn(`âš ï¸ ${type}æ”¶æ¬¾ç ä¸Šä¼ å¤±è´¥:`, error.message);
                    // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»æ­¢æ³¨å†Œ
                }
            }
        }
        
        async function createShopInSupabase() {
            console.log('ğŸª åˆ›å»ºå•†å®¶è®°å½•...');
            
            const shopData = {
                tenant_id: generatedShopId,
                name: shopConfig.name,
                slug: shopConfig.slug,
                contact_name: shopConfig.contact.name,
                contact_phone: shopConfig.contact.phone,
                contact_email: shopConfig.contact.email || null,
                description: shopConfig.description || null,
                shop_type: shopConfig.type,
                theme_color: shopConfig.themeColor,
                wechat_qr_url: shopConfig.qrCodes?.wechat?.url || null,
                alipay_qr_url: shopConfig.qrCodes?.alipay?.url || null,
                admin_password: shopConfig.password,
                is_active: true,
                created_at: shopConfig.createdAt,
                updated_at: shopConfig.createdAt
            };
            
            // æ’å…¥å•†å®¶è®°å½•
            const { data, error } = await supabaseClient
                .from('shops')
                .insert([shopData])
                .select();
            
            if (error) {
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºè¡¨
                if (error.message.includes('relation') && error.message.includes('does not exist')) {
                    console.log('ğŸ“Š shopsè¡¨ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...');
                    await createShopsTable();
                    
                    // é‡æ–°æ’å…¥æ•°æ®
                    const { data: retryData, error: retryError } = await supabaseClient
                        .from('shops')
                        .insert([shopData])
                        .select();
                    
                    if (retryError) throw retryError;
                    
                    console.log('âœ… å•†å®¶è®°å½•åˆ›å»ºæˆåŠŸ');
                    return retryData[0];
                }
                throw error;
            }
            
            console.log('âœ… å•†å®¶è®°å½•åˆ›å»ºæˆåŠŸ');
            return data[0];
        }
        
        async function createShopsTable() {
            console.log('âš ï¸ éœ€è¦æ‰‹åŠ¨åˆ›å»ºshopsè¡¨æˆ–ä½¿ç”¨Supabase SQLæ‰§è¡Œ');
            // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¸€ä¸ªEdge Functionæˆ–ä½¿ç”¨Supabaseçš„SQL API
        }
        
        async function initializeShopSettings() {
            console.log('âš™ï¸ åˆå§‹åŒ–å•†å®¶è®¾ç½®...');
            
            // æ³¨æ„ï¼šæˆ‘ä»¬ç§»é™¤äº†descriptionå­—æ®µï¼Œå› ä¸ºsettingsè¡¨æ²¡æœ‰è¿™ä¸ªåˆ—
            const settings = [
                {
                    tenant_id: generatedShopId,
                    setting_key: 'sequence_prefix',
                    setting_value: getSequencePrefix()
                },
                {
                    tenant_id: generatedShopId,
                    setting_key: 'sequence_counter',
                    setting_value: '1'
                },
                {
                    tenant_id: generatedShopId,
                    setting_key: 'shop_status',
                    setting_value: 'active'
                },
                {
                    tenant_id: generatedShopId,
                    setting_key: 'auto_refresh',
                    setting_value: 'true'
                },
                {
                    tenant_id: generatedShopId,
                    setting_key: 'notification_enabled',
                    setting_value: 'true'
                }
            ];
            
            // æ’å…¥è®¾ç½®è®°å½•
            const { error } = await supabaseClient
                .from('settings')
                .insert(settings);
            
            if (error) {
                // å¦‚æœæ˜¯RLSé”™è¯¯ï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
                if (error.message.includes('row-level security')) {
                    console.error('âŒ RLSç­–ç•¥é˜»æ­¢æ’å…¥ï¼Œè¯·è®¾ç½®Supabase RLSç­–ç•¥');
                    showRLSErrorMessage();
                }
                throw error;
            }
            
            console.log('âœ… å•†å®¶è®¾ç½®åˆå§‹åŒ–æˆåŠŸ');
        }
        
        function showRLSErrorMessage() {
            alert(`
âš ï¸ æ•°æ®åº“æƒé™é…ç½®é—®é¢˜

é”™è¯¯ï¼šè¡Œçº§å®‰å…¨ç­–ç•¥é˜»æ­¢æ’å…¥æ•°æ®

è§£å†³æ–¹æ¡ˆï¼š
1. ç™»å½• Supabase æ§åˆ¶å°
2. è¿›å…¥ Table Editor â†’ settings è¡¨
3. ç‚¹å‡» "Policies" æ ‡ç­¾
4. ç‚¹å‡» "New Policy" æˆ–ç¼–è¾‘ç°æœ‰ç­–ç•¥
5. æˆ–æ‰§è¡Œä»¥ä¸‹ SQLï¼š

-- å…è®¸æ’å…¥
CREATE POLICY "å…è®¸æ’å…¥è®¾ç½®" ON settings
FOR INSERT WITH CHECK (true);

-- å…è®¸æŸ¥è¯¢
CREATE POLICY "å…è®¸æŸ¥è¯¢è®¾ç½®" ON settings
FOR SELECT USING (true);
            `);
        }
        
        async function createDishesInSupabase() {
            console.log('ğŸœ åˆ›å»ºèœå“æ•°æ®...');
            
            const dishesData = shopConfig.dishes.map(dish => ({
                tenant_id: generatedShopId,
                name: dish.name,
                price: dish.price,
                category: dish.category,
                emoji: dish.emoji,
                tags: dish.tags || [],
                is_active: true,
                sort_order: dish.id,
                created_at: new Date().toISOString()
            }));
            
            const { error } = await supabaseClient
                .from('dishes')
                .insert(dishesData);
            
            if (error) {
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œè®°å½•é”™è¯¯ä½†ä¸é˜»æ­¢æ³¨å†Œ
                console.warn('âš ï¸ dishesè¡¨ä¸å­˜åœ¨ï¼Œèœå“æ•°æ®æœªä¿å­˜:', error.message);
                return;
            }
            
            console.log(`âœ… åˆ›å»ºäº† ${dishesData.length} ä¸ªèœå“`);
        }
        
        async function createRecommendations() {
            if (!shopConfig.recommendDishes || shopConfig.recommendDishes.length === 0) {
                console.log('ğŸ“ æœªè®¾ç½®æ¨èèœå“ï¼Œè·³è¿‡åˆ›å»º');
                return;
            }
            
            console.log('â­ åˆ›å»ºæ¨èèœå“...');
            
            const recommendations = shopConfig.recommendDishes.map((dishId, index) => ({
                tenant_id: generatedShopId,
                dish_id: parseInt(dishId),
                sort_order: index + 1,
                created_at: new Date().toISOString()
            }));
            
            const { error } = await supabaseClient
                .from('recommendations')
                .insert(recommendations);
            
            if (error) {
                console.warn('âš ï¸ åˆ›å»ºæ¨èèœå“å¤±è´¥:', error.message);
                return;
            }
            
            console.log(`âœ… åˆ›å»ºäº† ${recommendations.length} ä¸ªæ¨èèœå“`);
        }
        
        async function createMonitoringConfig() {
            console.log('ğŸ” åˆ›å»ºç›‘æ§é…ç½®...');
            
            const monitoringConfig = {
                tenant_id: generatedShopId,
                shop_name: shopConfig.name,
                alert_rules: {
                    max_pending_orders: 10,
                    max_waiting_time: 30,
                    check_interval: 5,
                    alert_channels: ['dashboard']
                },
                is_active: true,
                created_at: new Date().toISOString()
            };
            
            const { error } = await supabaseClient
                .from('monitoring_configs')
                .insert([monitoringConfig]);
            
            if (error) {
                console.warn('âš ï¸ åˆ›å»ºç›‘æ§é…ç½®å¤±è´¥:', error.message);
                return;
            }
            
            console.log('âœ… ç›‘æ§é…ç½®åˆ›å»ºæˆåŠŸ');
        }
        
        // ============================================
        // æ›´æ–°å…¨å±€é…ç½®æ–‡ä»¶å‡½æ•°ï¼ˆä¿®å¤åçš„æ ¸å¿ƒé€»è¾‘ï¼‰
        // ============================================
        async function updateGlobalConfig() {
            console.log('ğŸ“ æ›´æ–°å…¨å±€é…ç½®æ–‡ä»¶...');
            
            // è·å–æ”¶æ¬¾ç URLï¼ˆä¼˜å…ˆå¾®ä¿¡ï¼Œå…¶æ¬¡æ”¯ä»˜å®ï¼‰
            let qrcodeUrl = 'images/qrcode.jpg'; // é»˜è®¤æ”¶æ¬¾ç 
            if (shopConfig.qrCodes?.wechat?.url) {
                qrcodeUrl = shopConfig.qrCodes.wechat.url;
            } else if (shopConfig.qrCodes?.alipay?.url) {
                qrcodeUrl = shopConfig.qrCodes.alipay.url;
            }
            
            // ç”Ÿæˆå½“å‰å•†å®¶çš„é…ç½®
            const newShopConfig = {
                [generatedShopId]: {
                    name: shopConfig.name,
                    themeColor: shopConfig.themeColor,
                    logo: 'images/logo.png', // å›ºå®šä½¿ç”¨æœ¬åœ°logo
                    qrcode: qrcodeUrl, // ä½¿ç”¨ä¸Šä¼ çš„æ”¶æ¬¾ç URLæˆ–é»˜è®¤
                    dishes: shopConfig.dishes
                }
            };
            
            try {
                // 1. ä¿å­˜åˆ°localStorage
                localStorage.setItem('shop_config_' + generatedShopId, JSON.stringify(newShopConfig));
                
                // 2. æ›´æ–°å·²æ³¨å†Œå•†å®¶åˆ—è¡¨
                const allShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
                allShops[generatedShopId] = {
                    id: generatedShopId,
                    name: shopConfig.name,
                    created: shopConfig.createdAt,
                    themeColor: shopConfig.themeColor,
                    dishes: shopConfig.dishes
                };
                localStorage.setItem('registered_shops', JSON.stringify(allShops));
                
                // 3. åŠ¨æ€ç”ŸæˆåŒ…å«æ‰€æœ‰å•†å®¶çš„é…ç½®æ–‡ä»¶
                updatedConfigJS = await generateCompleteConfigJS(allShops);
                
                console.log('âœ… å…¨å±€é…ç½®å·²æ›´æ–°');
                
            } catch (error) {
                console.error('âŒ æ›´æ–°é…ç½®æ–‡ä»¶å¤±è´¥:', error);
                // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»æ­¢æ³¨å†Œ
            }
        }
        
        // ä¿®å¤ï¼šç”Ÿæˆå®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å·²æ³¨å†Œå•†å®¶
        async function generateCompleteConfigJS(allShops) {
            console.log('ğŸ”§ ç”Ÿæˆå®Œæ•´çš„é…ç½®æ–‡ä»¶...');
            
            // ä»localStorageåŠ è½½æ‰€æœ‰å•†å®¶çš„å®Œæ•´é…ç½®
            const allShopConfigs = {};
            
            // é¦–å…ˆæ·»åŠ é»˜è®¤å•†å®¶é…ç½®
            allShopConfigs['default_shop'] = {
                name: 'æˆ‘çš„æ‘Šä½',
                themeColor: '#E63946',
                logo: 'images/logo.png',
                qrcode: 'images/qrcode.jpg',
                dishes: [
                    { id: 1, name: 'æ‹›ç‰Œç‚¸é…±é¢', price: 15, emoji: 'ğŸœ', category: 'ä¸»é£Ÿ', tags: ['æ‹›ç‰Œ'] },
                    { id: 2, name: 'éº»è¾£çƒ«å¥—é¤', price: 18, emoji: 'ğŸ¥˜', category: 'çƒ­èœ', tags: ['å¥—é¤'] },
                    { id: 3, name: 'çƒ¤å†·é¢', price: 10, emoji: 'ğŸ¥', category: 'å°åƒ', tags: [] },
                    { id: 4, name: 'ç…é¥¼æœå­', price: 12, emoji: 'ğŸŒ¯', category: 'å°åƒ', tags: ['æ‹›ç‰Œ'] },
                    { id: 5, name: 'å‡‰æ‹Œé»„ç“œ', price: 8, emoji: 'ğŸ¥’', category: 'å‡‰èœ', tags: [] },
                    { id: 6, name: 'ç±³é¥­', price: 2, emoji: 'ğŸš', category: 'ä¸»é£Ÿ', tags: [] },
                    { id: 7, name: 'å¯ä¹', price: 4, emoji: 'ğŸ¥¤', category: 'é¥®æ–™', tags: [] },
                ]
            };
            
            // æ·»åŠ æ‰€æœ‰å·²æ³¨å†Œå•†å®¶
            for (const shopId in allShops) {
                try {
                    const shopData = allShops[shopId];
                    const fullConfig = JSON.parse(localStorage.getItem('shop_config_' + shopId));
                    
                    if (fullConfig && fullConfig[shopId]) {
                        // ä½¿ç”¨é…ç½®ï¼Œä½†ç¡®ä¿logoå­—æ®µæ­£ç¡®
                        allShopConfigs[shopId] = {
                            name: shopData.name,
                            themeColor: shopData.themeColor || '#E63946',
                            logo: 'images/logo.png', // å›ºå®šlogoè·¯å¾„
                            qrcode: fullConfig[shopId].qrcode || 'images/qrcode.jpg',
                            dishes: shopData.dishes || []
                        };
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°å®Œæ•´é…ç½®ï¼Œä½¿ç”¨åŸºæœ¬ä¿¡æ¯åˆ›å»ºé…ç½®
                        allShopConfigs[shopId] = {
                            name: shopData.name,
                            themeColor: shopData.themeColor || '#E63946',
                            logo: 'images/logo.png',
                            qrcode: 'images/qrcode.jpg',
                            dishes: shopData.dishes || []
                        };
                    }
                } catch (error) {
                    console.warn(`âš ï¸ æ— æ³•åŠ è½½å•†å®¶ ${shopId} çš„é…ç½®:`, error.message);
                }
            }
            
            // ç”Ÿæˆé…ç½®æ–‡ä»¶å†…å®¹
            const configContent = `// ============================================
// åŠ¨æ€å•†å®¶é…ç½®åŠ è½½å™¨
// ============================================

// ä»æœ¬åœ°å­˜å‚¨æˆ–SupabaseåŠ è½½å·²æ³¨å†Œçš„å•†å®¶
async function loadRegisteredShops() {
    try {
        // 1. å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½
        const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
        
        // 2. å¦‚æœæœ‰æœ¬åœ°å•†å®¶æ•°æ®ï¼Œåˆå¹¶åˆ°é…ç½®ä¸­
        Object.keys(localShops).forEach(shopId => {
            if (!window.shopConfigs[shopId]) {
                window.shopConfigs[shopId] = {
                    name: localShops[shopId].name,
                    themeColor: localShops[shopId].themeColor || '#E63946',
                    logo: 'images/logo.png',
                    qrcode: localShops[shopId].qrcode || 'images/qrcode.jpg',
                    dishes: localShops[shopId].dishes || []
                };
            }
        });
        
        console.log('âœ… åŠ¨æ€åŠ è½½å•†å®¶é…ç½®:', Object.keys(window.shopConfigs));
        
    } catch (error) {
        console.error('âŒ åŠ è½½å•†å®¶é…ç½®å¤±è´¥:', error);
    }
}

// ============================================
// ä»SupabaseåŠ¨æ€åŠ è½½å•†å®¶èœå“
// ============================================
async function loadShopDishesFromSupabase(shopId) {
    try {
        console.log('ğŸ“‹ ä»SupabaseåŠ è½½å•†å®¶èœå“ï¼Œå•†å®¶ID:', shopId);
        
        // æ£€æŸ¥Supabaseæ˜¯å¦å·²åˆå§‹åŒ–
        if (!window.supabaseClient) {
            console.log('ğŸ“ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨æœ¬åœ°èœå“');
            const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
            if (localShops[shopId] && localShops[shopId].dishes) {
                return localShops[shopId].dishes;
            }
            return [];
        }
        
        // ä»SupabaseåŠ è½½å•†å®¶çš„èœå“
        const { data: dishes, error } = await window.supabaseClient
            .from('dishes')
            .select('*')
            .eq('tenant_id', shopId)
            .eq('is_active', true)
            .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        if (dishes && dishes.length > 0) {
            console.log('âœ… ä»SupabaseåŠ è½½åˆ°èœå“:', dishes.length, 'ä¸ª');
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            const formattedDishes = dishes.map(dish => ({
                id: dish.id,
                name: dish.name,
                price: parseFloat(dish.price),
                emoji: dish.emoji || 'ğŸ½ï¸',
                category: dish.category || 'æœªåˆ†ç±»',
                tags: dish.tags || [],
                description: dish.description || ''
            }));
            
            return formattedDishes;
        }
        
        console.log('ğŸ“ Supabaseä¸­æ²¡æœ‰æ‰¾åˆ°èœå“ï¼Œè¿”å›æœ¬åœ°èœå“');
        // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
        const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
        if (localShops[shopId] && localShops[shopId].dishes) {
            return localShops[shopId].dishes;
        }
        
        return [];
        
    } catch (error) {
        console.error('âŒ ä»SupabaseåŠ è½½èœå“å¤±è´¥:', error);
        
        // å¤±è´¥æ—¶å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
        const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
        if (localShops[shopId] && localShops[shopId].dishes) {
            return localShops[shopId].dishes;
        }
        
        return [];
    }
}

// ============================================
// æ›´æ–°èœå“æ•°æ®çš„å‡½æ•°ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
// ============================================
async function updateShopDishes(shopId) {
    try {
        console.log('ğŸ”„ æ›´æ–°å•†å®¶èœå“æ•°æ®ï¼Œå•†å®¶ID:', shopId);
        
        // ä»SupabaseåŠ è½½èœå“
        const supabaseDishes = await loadShopDishesFromSupabase(shopId);
        
        // è·å–å½“å‰å•†å®¶é…ç½®
        const shopConfig = window.shopConfigs[shopId] || window.shopConfigs['default_shop'];
        
        if (supabaseDishes.length > 0) {
            // ä½¿ç”¨Supabaseä¸­çš„èœå“æ•°æ®
            shopConfig.dishes = supabaseDishes;
            console.log('âœ… å·²æ›´æ–°å•†å®¶èœå“æ•°æ®ï¼ˆæ¥è‡ªSupabaseï¼‰:', shopConfig.name);
        } else if (!shopConfig.dishes || shopConfig.dishes.length === 0) {
            // å¦‚æœSupabaseæ²¡æœ‰æ•°æ®ä¸”é…ç½®ä¸­ä¹Ÿæ²¡æœ‰èœå“ï¼Œä½¿ç”¨é»˜è®¤èœå“
            console.log('ğŸ“ ä½¿ç”¨é»˜è®¤èœå“æ•°æ®');
            shopConfig.dishes = window.shopConfigs['default_shop'].dishes || [];
        }
        
        return shopConfig.dishes;
        
    } catch (error) {
        console.error('âŒ æ›´æ–°èœå“æ•°æ®å¤±è´¥:', error);
        return [];
    }
}

// è·å–å½“å‰å•†å®¶é…ç½®ï¼ˆæ”¹è¿›ç‰ˆï¼‰
function getCurrentShopConfig() {
    const shopId = getCurrentShopId();
    
    // å¦‚æœé…ç½®ä¸­ä¸å­˜åœ¨ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    if (!window.shopConfigs[shopId]) {
        const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
        if (localShops[shopId]) {
            window.shopConfigs[shopId] = {
                name: localShops[shopId].name,
                themeColor: localShops[shopId].themeColor || '#E63946',
                logo: 'images/logo.png',
                qrcode: localShops[shopId].qrcode || 'images/qrcode.jpg',
                dishes: localShops[shopId].dishes || []
            };
        }
    }
    
    return window.shopConfigs[shopId] || window.shopConfigs['default_shop'];
}

// é¡µé¢åŠ è½½æ—¶è°ƒç”¨
document.addEventListener('DOMContentLoaded', async function() {
    // åŠ è½½å·²æ³¨å†Œçš„å•†å®¶
    await loadRegisteredShops();
    
    // å¦‚æœæ˜¯é¡¾å®¢ç«¯æˆ–ç®¡ç†ç«¯é¡µé¢ï¼Œåˆå§‹åŒ–Supabaseå¹¶åŠ è½½èœå“
    if (typeof window.supabaseClient !== 'undefined') {
        // è·å–å½“å‰å•†å®¶ID
        const currentShopId = getCurrentShopId();
        
        // æ›´æ–°å½“å‰å•†å®¶çš„èœå“æ•°æ®
        if (currentShopId) {
            await updateShopDishes(currentShopId);
        }
    }
    
    console.log('âœ… å•†å®¶é…ç½®åŠ è½½å®Œæˆ');
});

// ============================================
// å•†å®¶é…ç½®æ–‡ä»¶ - å¤šå•†å®¶æ”¯æŒ
// ============================================

// æ”¯æŒçš„å•†å®¶åˆ—è¡¨
window.shopConfigs = ${JSON.stringify(allShopConfigs, null, 4)};

// è·å–å½“å‰å•†å®¶ID - ç®¡ç†å‘˜ä¸“ç”¨ç‰ˆæœ¬ï¼ˆå®Œå…¨ä»URLè·å–ï¼‰
function getCurrentShopId() {
    // åªä»URLå‚æ•°è·å–ï¼Œå¦‚ ?shop=è€ç‹ç…é¥¼
    const urlParams = new URLSearchParams(window.location.search);
    let shopId = urlParams.get('shop');
    
    // å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤
    if (!shopId || !window.shopConfigs[shopId]) {
        shopId = 'default_shop';
    }
    
    return shopId;
}

// è·å–å½“å‰å•†å®¶é…ç½®
function getCurrentShopConfig() {
    const shopId = getCurrentShopId();
    return window.shopConfigs[shopId] || window.shopConfigs['default_shop'];
}

// æ›´æ–°é¡µé¢ä¸»é¢˜
function updateThemeForShop(shopConfig) {
    // æ›´æ–°CSSå˜é‡
    if (shopConfig && shopConfig.themeColor) {
        document.documentElement.style.setProperty('--primary-color', shopConfig.themeColor);
    }
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    if (shopConfig && shopConfig.name) {
        document.title = \`\${shopConfig.name} - æ‰«ç ç‚¹é¤\`;
    }
    
    // æ›´æ–°Logoï¼ˆå¦‚æœæœ‰ï¼‰
    if (shopConfig && shopConfig.logo) {
        const logoImg = document.querySelector('.logo-image');
        if (logoImg) {
            logoImg.src = shopConfig.logo;
            logoImg.alt = shopConfig.name;
        }
    }
}

// è‡ªåŠ¨åˆå¹¶å·²æ³¨å†Œå•†å®¶åˆ°é…ç½®ä¸­
function autoMergeRegisteredShops() {
    try {
        const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
        
        for (const shopId in localShops) {
            if (!window.shopConfigs[shopId]) {
                const shopData = localShops[shopId];
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–å®Œæ•´é…ç½®
                const fullConfig = JSON.parse(localStorage.getItem('shop_config_' + shopId) || '{}');
                
                if (fullConfig && fullConfig[shopId]) {
                    // ä½¿ç”¨å®Œæ•´é…ç½®ï¼Œä½†ç¡®ä¿logoå­—æ®µæ­£ç¡®
                    window.shopConfigs[shopId] = {
                        name: shopData.name,
                        themeColor: shopData.themeColor || '#E63946',
                        logo: 'images/logo.png', // å›ºå®šlogoè·¯å¾„
                        qrcode: fullConfig[shopId].qrcode || 'images/qrcode.jpg',
                        dishes: shopData.dishes || []
                    };
                } else {
                    // ä½¿ç”¨åŸºæœ¬ä¿¡æ¯åˆ›å»ºé…ç½®
                    window.shopConfigs[shopId] = {
                        name: shopData.name,
                        themeColor: shopData.themeColor || '#E63946',
                        logo: 'images/logo.png',
                        qrcode: 'images/qrcode.jpg',
                        dishes: shopData.dishes || []
                    };
                }
                
                console.log(\`âœ… è‡ªåŠ¨æ·»åŠ å•†å®¶é…ç½®: \${shopData.name} (\${shopId})\`);
            }
        }
    } catch (error) {
        console.error('âŒ è‡ªåŠ¨åˆå¹¶å•†å®¶é…ç½®å¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå¹¶
document.addEventListener('DOMContentLoaded', function() {
    autoMergeRegisteredShops();
    console.log('âœ… å•†å®¶é…ç½®è‡ªåŠ¨åˆå¹¶å®Œæˆ');
});

console.log('âœ… å•†å®¶é…ç½®åŠ è½½å®Œæˆ');`;
            
            return configContent;
        }
        
        // ============================================
        // æˆåŠŸé¡µé¢æ˜¾ç¤º
        // ============================================
        function showSuccessScreen() {
            // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºæˆåŠŸé¡µé¢
            document.querySelector('.form-content').style.display = 'none';
            document.querySelector('.register-stepper').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            
            // å¡«å……æˆåŠŸé¡µé¢ä¿¡æ¯
            document.getElementById('finalShopId').textContent = generatedShopId;
            document.getElementById('finalShopName').textContent = shopConfig.name;
            
            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„é“¾æ¥
            const adminLink = `admin.html?shop=${generatedShopId}`;
            const customerLink = `index.html?shop=${generatedShopId}`;
            
            document.getElementById('finalAdminLink').href = adminLink;
            document.getElementById('finalCustomerLink').href = customerLink;
            
            // è®¾ç½®é“¾æ¥ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿å…ˆä¿å­˜é…ç½®
            document.getElementById('finalAdminLink').onclick = function(e) {
                updateLocalConfigBeforeNavigate();
                // å…è®¸é»˜è®¤é“¾æ¥è¡Œä¸º
                return true;
            };
            
            document.getElementById('finalCustomerLink').onclick = function(e) {
                updateLocalConfigBeforeNavigate();
                return true;
            };
            
            document.getElementById('finalPassword').textContent = shopConfig.password;
            
            // æ˜¾ç¤ºé…ç½®æ–‡ä»¶ä¸‹è½½åŒºåŸŸ
            if (updatedConfigJS) {
                document.getElementById('configDownloadArea').style.display = 'block';
                document.getElementById('configStatusMessage').textContent = 'è¯·ä¸‹è½½å¹¶æ›¿æ¢é…ç½®æ–‡ä»¶ï¼Œè¿™æ ·æ–°å•†å®¶æ‰èƒ½æ­£å¸¸è®¿é—®ã€‚';
                document.getElementById('configStatusMessage').style.color = '#ff9800';
            } else {
                document.getElementById('configStatusMessage').textContent = 'æœ¬åœ°é…ç½®å·²æ›´æ–°ï¼Œæ–°å•†å®¶å¯ä»¥æ­£å¸¸è®¿é—®ã€‚';
                document.getElementById('configStatusMessage').style.color = '#4CAF50';
            }
            
            // æ˜¾ç¤ºæˆåŠŸé¡µé¢
            document.getElementById('successScreen').style.display = 'block';
        }
        
        function updateLocalConfigBeforeNavigate() {
            // è·å–æ”¶æ¬¾ç URLï¼ˆä¼˜å…ˆå¾®ä¿¡ï¼Œå…¶æ¬¡æ”¯ä»˜å®ï¼‰
            let qrcodeUrl = 'images/qrcode.jpg'; // é»˜è®¤æ”¶æ¬¾ç 
            if (shopConfig.qrCodes?.wechat?.url) {
                qrcodeUrl = shopConfig.qrCodes.wechat.url;
            } else if (shopConfig.qrCodes?.alipay?.url) {
                qrcodeUrl = shopConfig.qrCodes.alipay.url;
            }
            
            // ç¡®ä¿æ–°å•†å®¶é…ç½®å·²ä¿å­˜åˆ°localStorage
            const newShopConfig = {
                [generatedShopId]: {
                    name: shopConfig.name,
                    themeColor: shopConfig.themeColor,
                    logo: 'images/logo.png',
                    qrcode: qrcodeUrl,
                    dishes: shopConfig.dishes
                }
            };
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('shop_config_' + generatedShopId, JSON.stringify(newShopConfig));
            
            // æ›´æ–°å·²æ³¨å†Œå•†å®¶åˆ—è¡¨
            const registeredShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
            registeredShops[generatedShopId] = {
                id: generatedShopId,
                name: shopConfig.name,
                themeColor: shopConfig.themeColor,
                dishes: shopConfig.dishes,
                qrcode: qrcodeUrl,
                created: new Date().toISOString()
            };
            localStorage.setItem('registered_shops', JSON.stringify(registeredShops));
            
            console.log('âœ… å•†å®¶é…ç½®å·²ä¿å­˜åˆ°localStorageï¼Œå¯ä»¥è®¿é—®äº†');
        }
        
        // ============================================
        // å·¥å…·å‡½æ•°
        // ============================================
        function convertToSlug(text) {
            // ç®€åŒ–çš„ä¸­æ–‡è½¬æ‹¼éŸ³/è‹±æ–‡å¤„ç†
            return text.toLowerCase()
                .replace(/[^\w\u4e00-\u9fa5]+/g, '')
                .replace(/[\u4e00-\u9fa5]/g, function(char) {
                    // ç®€å•çš„ä¸­æ–‡è½¬æ‹¼éŸ³æ˜ å°„ï¼ˆå®é™…åº”ä½¿ç”¨æ‹¼éŸ³åº“ï¼‰
                    const map = {
                        'ç‹': 'wang', 'æ': 'li', 'å¼ ': 'zhang', 'åˆ˜': 'liu', 'é™ˆ': 'chen',
                        'æ¨': 'yang', 'é»„': 'huang', 'èµµ': 'zhao', 'å‘¨': 'zhou', 'å´': 'wu',
                        'ç…': 'jian', 'é¥¼': 'bing', 'çƒ§': 'shao', 'çƒ¤': 'kao', 'é¢': 'mian',
                        'é¥­': 'fan', 'èœ': 'cai', 'åº—': 'dian', 'é“º': 'pu', 'æ‘Š': 'tan'
                    };
                    return map[char] || char;
                })
                .replace(/[^a-z0-9]/g, '');
        }
        
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }
        
        function resetThemeColor() {
            document.getElementById('themeColor').value = '#E63946';
            document.getElementById('themeColorText').value = '#E63946';
            shopConfig.themeColor = '#E63946';
            updateConfigPreview();
        }
        
        // ============================================
        // æˆåŠŸé¡µé¢æ“ä½œå‡½æ•°
        // ============================================
        function openAdminPanel() {
            const adminLink = document.getElementById('finalAdminLink').href;
            updateLocalConfigBeforeNavigate();
            window.open(adminLink, '_blank');
        }
        
        function downloadUpdatedConfig() {
            if (!updatedConfigJS) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„é…ç½®æ–‡ä»¶');
                return;
            }
            
            const blob = new Blob([updatedConfigJS], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'config_updated.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('é…ç½®æ–‡ä»¶å·²ä¸‹è½½ï¼Œè¯·æ›¿æ¢é¡¹ç›®ä¸­çš„ config.js æ–‡ä»¶ã€‚\n\næ›¿æ¢æ­¥éª¤ï¼š\n1. ä¸‹è½½æ–‡ä»¶ config_updated.js\n2. é‡å‘½åä¸º config.js\n3. æ›¿æ¢é¡¹ç›®ä¸­çš„ config.js æ–‡ä»¶');
        }
        
        function showManualConfigInstructions() {
            // è·å–æ‰€æœ‰å·²æ³¨å†Œå•†å®¶
            const registeredShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
            let manualConfig = '// ============================================\n';
            manualConfig += '// æ‰‹åŠ¨æ·»åŠ å•†å®¶é…ç½® - å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° config.js\n';
            manualConfig += '// ============================================\n\n';
            
            // æ·»åŠ é»˜è®¤å•†å®¶
            manualConfig += "'default_shop': {\n";
            manualConfig += "    name: 'æˆ‘çš„æ‘Šä½',\n";
            manualConfig += "    themeColor: '#E63946',\n";
            manualConfig += "    logo: 'images/logo.png',\n";
            manualConfig += "    qrcode: 'images/qrcode.jpg',\n";
            manualConfig += "    dishes: [\n";
            manualConfig += "        { id: 1, name: 'æ‹›ç‰Œç‚¸é…±é¢', price: 15, emoji: 'ğŸœ', category: 'ä¸»é£Ÿ', tags: ['æ‹›ç‰Œ'] },\n";
            manualConfig += "        { id: 2, name: 'éº»è¾£çƒ«å¥—é¤', price: 18, emoji: 'ğŸ¥˜', category: 'çƒ­èœ', tags: ['å¥—é¤'] },\n";
            manualConfig += "        { id: 3, name: 'çƒ¤å†·é¢', price: 10, emoji: 'ğŸ¥', category: 'å°åƒ', tags: [] },\n";
            manualConfig += "        { id: 4, name: 'ç…é¥¼æœå­', price: 12, emoji: 'ğŸŒ¯', category: 'å°åƒ', tags: ['æ‹›ç‰Œ'] },\n";
            manualConfig += "        { id: 5, name: 'å‡‰æ‹Œé»„ç“œ', price: 8, emoji: 'ğŸ¥’', category: 'å‡‰èœ', tags: [] },\n";
            manualConfig += "        { id: 6, name: 'ç±³é¥­', price: 2, emoji: 'ğŸš', category: 'ä¸»é£Ÿ', tags: [] },\n";
            manualConfig += "        { id: 7, name: 'å¯ä¹', price: 4, emoji: 'ğŸ¥¤', category: 'é¥®æ–™', tags: [] },\n";
            manualConfig += "    ]\n";
            manualConfig += "},\n\n";
            
            // æ·»åŠ æ‰€æœ‰å·²æ³¨å†Œå•†å®¶
            for (const shopId in registeredShops) {
                const shopData = registeredShops[shopId];
                
                manualConfig += `'${shopId}': {\n`;
                manualConfig += `    name: '${shopData.name}',\n`;
                manualConfig += `    themeColor: '${shopData.themeColor || '#E63946'}',\n`;
                manualConfig += `    logo: 'images/logo.png',\n`;
                manualConfig += `    qrcode: '${shopData.qrcode || 'images/qrcode.jpg'}',\n`;
                
                if (shopData.dishes && shopData.dishes.length > 0) {
                    manualConfig += `    dishes: ${JSON.stringify(shopData.dishes, null, 4)}\n`;
                } else {
                    manualConfig += "    dishes: []\n";
                }
                
                manualConfig += "},\n\n";
            }
            
            manualConfig += "// å°†æ­¤é…ç½®æ·»åŠ åˆ° window.shopConfigs å¯¹è±¡ä¸­";
            
            // åˆ›å»ºå¼¹çª—æ˜¾ç¤ºæ‰‹åŠ¨é…ç½®è¯´æ˜
            const modal = document.createElement('div');
            modal.className = 'manual-config-modal';
            modal.innerHTML = `
                <div class="manual-config-content">
                    <h3 class="manual-config-title">
                        <i class="fas fa-code"></i> æ‰‹åŠ¨é…ç½®è¯´æ˜
                    </h3>
                    
                    <div class="manual-config-steps">
                        <p><strong>æ“ä½œæ­¥éª¤ï¼š</strong></p>
                        <ol>
                            <li>æ‰“å¼€é¡¹ç›®ä¸­çš„ <code>config.js</code> æ–‡ä»¶</li>
                            <li>æ‰¾åˆ° <code>window.shopConfigs = {}</code> éƒ¨åˆ†</li>
                            <li>å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°é…ç½®å¯¹è±¡ä¸­</li>
                            <li>ä¿å­˜æ–‡ä»¶å¹¶åˆ·æ–°é¡µé¢</li>
                        </ol>
                    </div>
                    
                    <div class="manual-config-code">${manualConfig}</div>
                    
                    <div style="text-align: center;">
                        <button onclick="copyConfigToClipboard()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-copy"></i> å¤åˆ¶é…ç½®ä»£ç 
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ å¤åˆ¶åŠŸèƒ½
            window.copyConfigToClipboard = function() {
                navigator.clipboard.writeText(manualConfig).then(function() {
                    alert('é…ç½®ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }, function(err) {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶ä¸Šé¢çš„ä»£ç ã€‚');
                });
            };
        }
        
        function showQRCode() {
            const customerLink = document.getElementById('finalCustomerLink').href;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 400px;
                    width: 100%;
                    text-align: center;
                ">
                    <h3 style="margin-bottom: 20px; color: #333;">
                        <i class="fas fa-qrcode"></i> é¡¾å®¢ç‚¹é¤äºŒç»´ç 
                    </h3>
                    <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <div id="qrcodeContainer" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                    </div>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                        å°†äºŒç»´ç æ‰“å°å‡ºæ¥ï¼Œé¡¾å®¢æ‰«ç å³å¯ç‚¹é¤
                    </p>
                    <p style="color: #999; font-size: 12px; margin-bottom: 20px;">
                        é“¾æ¥: ${customerLink}
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="printQRCode()" style="
                            padding: 10px 20px;
                            background: #2196F3;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">
                            <i class="fas fa-print"></i> æ‰“å°äºŒç»´ç 
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                            padding: 10px 20px;
                            background: #f8f9fa;
                            color: #666;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            cursor: pointer;
                        ">
                            å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç”ŸæˆäºŒç»´ç ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
            generateSimpleQRCode(customerLink, 'qrcodeContainer');
        }
        
        function generateSimpleQRCode(text, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // åˆ›å»ºCanvasç»˜åˆ¶äºŒç»´ç 
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 200, 200);
            
            // ç»˜åˆ¶ç®€å•äºŒç»´ç å›¾æ¡ˆ
            ctx.fillStyle = 'black';
            
            // ç»˜åˆ¶å®šä½ç‚¹
            ctx.fillRect(20, 20, 40, 40);
            ctx.fillRect(140, 20, 40, 40);
            ctx.fillRect(20, 140, 40, 40);
            
            // ç»˜åˆ¶ç®€å•æ–‡å­—
            ctx.font = '12px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText('æ‰«ç ç‚¹é¤', 100, 180);
            ctx.font = '10px Arial';
            ctx.fillText(shopConfig.name.substr(0, 10), 100, 195);
            
            container.innerHTML = '';
            container.appendChild(canvas);
        }
        
        function printQRCode() {
            window.print();
        }
        
        function startNewRegistration() {
            // é‡ç½®é¡µé¢çŠ¶æ€
            currentStep = 1;
            shopConfig = {
                id: '',
                name: '',
                slug: '',
                contact: {},
                themeColor: '#E63946',
                dishes: [],
                qrCodes: {},
                settings: {},
                createdAt: new Date().toISOString()
            };
            generatedShopId = '';
            updatedConfigJS = null;
            
            // é‡ç½®è¡¨å•
            document.getElementById('shopName').value = '';
            document.getElementById('shopSlug').value = '';
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('shopDescription').value = '';
            document.getElementById('themeColor').value = '#E63946';
            document.getElementById('themeColorText').value = '#E63946';
            
            // é‡ç½®èœå“
            document.getElementById('dishesList').innerHTML = `
                <div class="dish-item">
                    <input type="text" class="dish-name" placeholder="èœå“åç§°" value="æ‹›ç‰Œç‚¸é…±é¢">
                    <input type="number" class="dish-price" placeholder="ä»·æ ¼" value="15" min="0" step="0.01">
                    <select class="dish-category">
                        <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                        <option value="çƒ­èœ">çƒ­èœ</option>
                        <option value="å°åƒ">å°åƒ</option>
                        <option value="å‡‰èœ">å‡‰èœ</option>
                        <option value="é¥®æ–™">é¥®æ–™</option>
                    </select>
                    <input type="text" class="dish-emoji" placeholder="å›¾æ ‡" value="ğŸœ" maxlength="2">
                    <button type="button" class="btn-remove-dish" onclick="removeDish(this)" disabled>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="dish-item">
                    <input type="text" class="dish-name" placeholder="èœå“åç§°" value="éº»è¾£çƒ«å¥—é¤">
                    <input type="number" class="dish-price" placeholder="ä»·æ ¼" value="18" min="0" step="0.01">
                    <select class="dish-category">
                        <option value="çƒ­èœ">çƒ­èœ</option>
                        <option value="ä¸»é£Ÿ" selected>ä¸»é£Ÿ</option>
                        <option value="å°åƒ">å°åƒ</option>
                        <option value="å‡‰èœ">å‡‰èœ</option>
                        <option value="é¥®æ–™">é¥®æ–™</option>
                    </select>
                    <input type="text" class="dish-emoji" placeholder="å›¾æ ‡" value="ğŸ¥˜" maxlength="2">
                    <button type="button" class="btn-remove-dish" onclick="removeDish(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            updateRecommendSelect();
            
            // é‡ç½®æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('wechatQR').value = '';
            document.getElementById('alipayQR').value = '';
            document.getElementById('wechatPreview').style.display = 'none';
            document.getElementById('alipayPreview').style.display = 'none';
            document.getElementById('wechatUploadArea').style.display = 'block';
            document.getElementById('alipayUploadArea').style.display = 'block';
            
            // é‡ç½®å¯†ç 
            document.getElementById('adminPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === 0) {
                    step.classList.add('completed');
                }
                if (index === 1) {
                    step.classList.add('active');
                }
            });
            
            // é‡ç½®è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = '25%';
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('nextBtn').innerHTML = 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>';
            document.getElementById('nextBtn').className = 'btn btn-next';
            document.getElementById('nextBtn').onclick = nextStep;
            document.getElementById('nextBtn').disabled = false;
            
            // æ˜¾ç¤ºè¡¨å•ï¼Œéšè—æˆåŠŸé¡µé¢
            document.querySelector('.form-content').style.display = 'block';
            document.querySelector('.register-stepper').style.display = 'flex';
            document.querySelector('.progress-bar').style.display = 'block';
            document.getElementById('successScreen').style.display = 'none';
            
            // æ¿€æ´»ç¬¬ä¸€æ­¥
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('stepForm1').classList.add('active');
            
            // æ›´æ–°é¢„è§ˆ
            updateConfigPreview();
        }
    </script>
</body>
</html>