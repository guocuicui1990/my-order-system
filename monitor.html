<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统一监控告警系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .monitor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .monitor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.warning {
            background: #ff9800;
        }
        
        .status-dot.danger {
            background: #f44336;
        }
        
        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* 主内容区 */
        .monitor-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        /* 左侧商家列表 */
        .shops-sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .shops-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .shops-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .shop-item {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .shop-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .shop-item.active {
            border-color: #667eea;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1), transparent);
        }
        
        .shop-name {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shop-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .shop-status.online { background: #4CAF50; }
        .shop-status.offline { background: #f44336; }
        .shop-status.warning { background: #ff9800; }
        
        .shop-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        /* 右侧监控面板 */
        .monitor-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .selected-shop {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .shop-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .shop-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .shop-info p {
            font-size: 12px;
            color: #666;
        }
        
        /* 监控卡片 */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .monitor-card {
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .card-orders {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .card-revenue {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .card-waiting {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .card-alerts {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .card-trend {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 图表容器 */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            border: 2px dashed #eee;
            border-radius: 8px;
        }
        
        /* 告警列表 */
        .alerts-section {
            margin-top: 30px;
        }
        
        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .alert-filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }
        
        .alert-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .alert-item.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .alert-info {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-desc {
            font-size: 12px;
            color: #666;
        }
        
        .alert-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            margin-left: 15px;
        }
        
        .alert-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-acknowledge {
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .btn-silence {
            padding: 4px 10px;
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        /* 实时指示器 */
        .realtime-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 10px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            z-index: 1000;
        }
        
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }
        
        /* 动画 */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .monitor-content {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .shops-sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="monitor-container">
        <!-- 头部 -->
        <div class="monitor-header">
            <div class="header-top">
                <div class="header-title">
                    <i class="fas fa-tachometer-alt"></i> 统一监控告警系统
                </div>
                <div class="system-status">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>系统运行正常</span>
                    </div>
                    <span id="lastUpdate">最后更新: -</span>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalShops">0</div>
                    <div class="stat-label">总商家数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeShops">0</div>
                    <div class="stat-label">在线商家</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayOrders">0</div>
                    <div class="stat-label">今日订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">¥0</div>
                    <div class="stat-label">今日营收</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeAlerts">0</div>
                    <div class="stat-label">活跃告警</div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="monitor-content">
            <!-- 左侧商家列表 -->
            <div class="shops-sidebar">
                <div class="shops-header">
                    <h3><i class="fas fa-store"></i> 商家列表</h3>
                    <button onclick="refreshShops()" style="background: none; border: none; color: #667eea; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="shops-list" id="shopsList">
                    <!-- 动态加载商家 -->
                    <div class="shop-loading" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载商家列表...
                    </div>
                </div>
            </div>
            
            <!-- 右侧监控面板 -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <div class="selected-shop">
                        <div class="shop-avatar" id="selectedShopAvatar">?</div>
                        <div class="shop-info">
                            <h3 id="selectedShopName">请选择商家</h3>
                            <p id="selectedShopId">-</p>
                        </div>
                    </div>
                    
                    <div class="panel-actions">
                        <button onclick="openShopAdmin()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-external-link-alt"></i> 进入后台
                        </button>
                        <button onclick="refreshShopData()" style="padding: 8px 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> 刷新数据
                        </button>
                    </div>
                </div>
                
                <!-- 监控卡片 -->
                <div class="monitor-grid">
                    <div class="monitor-card card-orders">
                        <div class="card-title">
                            <i class="fas fa-clipboard-list"></i> 今日订单
                        </div>
                        <div class="card-value" id="cardOrders">0</div>
                        <div class="card-trend" id="ordersTrend">
                            <i class="fas fa-arrow-up"></i> 0% 对比昨日
                        </div>
                    </div>
                    
                    <div class="monitor-card card-revenue">
                        <div class="card-title">
                            <i class="fas fa-yen-sign"></i> 今日营收
                        </div>
                        <div class="card-value" id="cardRevenue">¥0</div>
                        <div class="card-trend" id="revenueTrend">
                            <i class="fas fa-arrow-up"></i> 0% 对比昨日
                        </div>
                    </div>
                    
                    <div class="monitor-card card-waiting">
                        <div class="card-title">
                            <i class="fas fa-clock"></i> 等待处理
                        </div>
                        <div class="card-value" id="cardWaiting">0</div>
                        <div class="card-trend">
                            平均等待: <span id="avgWaitTime">0</span>分钟
                        </div>
                    </div>
                    
                    <div class="monitor-card card-alerts">
                        <div class="card-title">
                            <i class="fas fa-exclamation-triangle"></i> 告警状态
                        </div>
                        <div class="card-value" id="cardAlerts">0</div>
                        <div class="card-trend" id="alertsTrend">
                            正常
                        </div>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i> 今日订单趋势
                            </div>
                            <select id="timeRange" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="today">今日</option>
                                <option value="yesterday">昨日</option>
                                <option value="week">本周</option>
                                <option value="month">本月</option>
                            </select>
                        </div>
                        <div class="chart-placeholder" id="ordersChart">
                            订单趋势图表区域
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i> 订单状态分布
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                实时更新
                            </div>
                        </div>
                        <div class="chart-placeholder" id="statusChart">
                            订单状态分布图表区域
                        </div>
                    </div>
                </div>
                
                <!-- 告警列表 -->
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3><i class="fas fa-bell"></i> 实时告警</h3>
                        <div class="alert-filters">
                            <button class="filter-btn active" onclick="filterAlerts('all')">全部</button>
                            <button class="filter-btn" onclick="filterAlerts('warning')">警告</button>
                            <button class="filter-btn" onclick="filterAlerts('critical')">严重</button>
                            <button class="filter-btn" onclick="filterAlerts('resolved')">已解决</button>
                        </div>
                    </div>
                    
                    <div class="alerts-list" id="alertsList">
                        <div class="alert-placeholder" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                            <p>当前无告警信息</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 实时指示器 -->
        <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
            <div class="pulse-dot"></div>
            <span>实时更新中...</span>
        </div>
    </div>

    <!-- 引入图表库（实际使用时可引入ECharts或Chart.js） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <script>
        // ============================================
        // 全局变量和配置
        // ============================================
        const SUPABASE_URL = 'https://slonbvmhsxqgpoodwazj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb25idm1oc3hxZ3Bvb2R3YXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzMyNjQsImV4cCI6MjA4NDYwOTI2NH0.YLZqdnZl1vDTOrT6bzi2ulN1BGRxKGyW30AuccuWJq4';
        
        let supabaseClient = null;
        let currentShopId = null;
        let shops = [];
        let alerts = [];
        let realtimeSubscriptions = [];
        let charts = {};
        let refreshInterval = null;
        
        // ============================================
        // 初始化函数
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 统一监控系统初始化...');
            
            // 初始化Supabase客户端
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // 加载所有商家
            await loadAllShops();
            
            // 设置自动刷新
            startAutoRefresh();
            
            // 初始化图表
            initCharts();
            
            console.log('✅ 监控系统初始化完成');
        });
        
        // ============================================
        // 商家管理函数
        // ============================================
        async function loadAllShops() {
            try {
                console.log('📋 加载商家列表...');
                
                // 1. 首先尝试从Supabase加载
                const { data: supabaseShops, error } = await supabaseClient
                    .from('shops')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.warn('⚠️ 从Supabase加载商家失败:', error.message);
                    
                    // 2. 尝试从本地存储加载
                    const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
                    
                    if (Object.keys(localShops).length > 0) {
                        console.log('📝 从本地存储加载商家:', Object.keys(localShops).length);
                        shops = Object.values(localShops);
                        renderShopsList();
                        updateSystemStats();
                        return;
                    }
                    
                    // 3. 使用模拟数据
                    console.log('📝 使用模拟商家数据');
                    shops = getMockShops();
                    
                } else if (supabaseShops && supabaseShops.length > 0) {
                    console.log('✅ 从Supabase加载商家:', supabaseShops.length);
                    shops = supabaseShops;
                    
                } else {
                    // 没有商家数据，从本地存储获取
                    const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
                    if (Object.keys(localShops).length > 0) {
                        shops = Object.values(localShops);
                    } else {
                        shops = getMockShops();
                    }
                }
                
                // 渲染商家列表
                renderShopsList();
                
                // 更新系统统计
                updateSystemStats();
                
                // 默认选择第一个商家
                if (shops.length > 0 && !currentShopId) {
                    selectShop(shops[0].tenant_id || shops[0].id);
                }
                
            } catch (error) {
                console.error('❌ 加载商家列表失败:', error);
                shops = getMockShops();
                renderShopsList();
                updateSystemStats();
            }
        }
        
        function renderShopsList() {
            const shopsList = document.getElementById('shopsList');
            if (!shopsList) return;
            
            if (shops.length === 0) {
                shopsList.innerHTML = `
                    <div class="shop-empty" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-store-slash" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>暂无商家数据</p>
                        <button onclick="window.open('register.html', '_blank')" style="margin-top: 15px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-plus"></i> 添加新商家
                        </button>
                    </div>
                `;
                return;
            }
            
            shopsList.innerHTML = shops.map(shop => {
                const shopId = shop.tenant_id || shop.id;
                const isActive = shop.is_active !== false;
                const isSelected = shopId === currentShopId;
                
                // 模拟状态（实际应从实时数据获取）
                const status = isActive ? 'online' : 'offline';
                const statusText = isActive ? '在线' : '离线';
                
                return `
                <div class="shop-item ${isSelected ? 'active' : ''}" onclick="selectShop('${shopId}')">
                    <div class="shop-name">
                        <i class="fas fa-${shop.shop_type === 'drink' ? 'wine-glass' : 'utensils'}"></i>
                        ${shop.name}
                    </div>
                    <div class="shop-meta">
                        <span>${formatDate(shop.created_at)}</span>
                        <span>${statusText}</span>
                    </div>
                    <div class="shop-status ${status}"></div>
                </div>
                `;
            }).join('');
        }
        
        function selectShop(shopId) {
            console.log('🏪 选择商家:', shopId);
            currentShopId = shopId;
            
            // 更新UI
            renderShopsList();
            updateSelectedShopDisplay();
            
            // 加载商家数据
            loadShopData(shopId);
            
            // 开始实时订阅
            startRealtimeSubscription(shopId);
        }
        
        function updateSelectedShopDisplay() {
            const shop = shops.find(s => (s.tenant_id || s.id) === currentShopId);
            if (!shop) return;
            
            document.getElementById('selectedShopName').textContent = shop.name;
            document.getElementById('selectedShopId').textContent = shop.tenant_id || shop.id;
            
            // 更新头像
            const avatar = document.getElementById('selectedShopAvatar');
            avatar.textContent = shop.name.charAt(0).toUpperCase();
            avatar.style.background = shop.theme_color || `linear-gradient(135deg, #667eea, #764ba2)`;
        }
        
        // ============================================
        // 数据加载和实时订阅
        // ============================================
        async function loadShopData(shopId) {
            try {
                console.log(`📊 加载商家数据: ${shopId}`);
                
                // 显示加载状态
                showRealtimeIndicator(true);
                
                // 1. 加载今日订单统计
                await loadTodayStats(shopId);
                
                // 2. 加载订单趋势数据
                await loadOrdersTrend(shopId);
                
                // 3. 加载订单状态分布
                await loadStatusDistribution(shopId);
                
                // 4. 加载告警数据
                await loadAlerts(shopId);
                
                // 更新卡片数据
                updateMonitorCards();
                
                // 隐藏加载状态
                setTimeout(() => showRealtimeIndicator(false), 1000);
                
            } catch (error) {
                console.error(`❌ 加载商家数据失败:`, error);
                showRealtimeIndicator(false);
            }
        }
        
        async function loadTodayStats(shopId) {
            try {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
                
                // 获取今日订单
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .eq('tenant_id', shopId)
                    .gte('created_at', todayStart)
                    .lt('created_at', todayEnd);
                
                if (error) {
                    console.warn('获取今日订单失败:', error.message);
                    return;
                }
                
                // 计算统计
                const totalOrders = orders ? orders.length : 0;
                const pendingOrders = orders ? orders.filter(o => o.status === '新订单').length : 0;
                const totalRevenue = orders ? orders
                    .filter(o => o.status === '已完成')
                    .reduce((sum, o) => sum + (o.total_amount || 0), 0) : 0;
                
                // 保存到全局变量供其他函数使用
                window.todayStats = {
                    orders: orders || [],
                    total: totalOrders,
                    pending: pendingOrders,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('加载今日统计失败:', error);
            }
        }
        
        async function loadOrdersTrend(shopId) {
            try {
                // 模拟数据（实际应从数据库查询）
                const hours = Array.from({length: 24}, (_, i) => i);
                const mockData = hours.map(hour => ({
                    hour: hour,
                    orders: Math.floor(Math.random() * 10) + 1
                }));
                
                // 更新图表
                updateOrdersChart(mockData);
                
            } catch (error) {
                console.error('加载订单趋势失败:', error);
            }
        }
        
        async function loadStatusDistribution(shopId) {
            try {
                // 模拟数据
                const statusData = [
                    { status: '新订单', count: 5, color: '#667eea' },
                    { status: '处理中', count: 3, color: '#ff9800' },
                    { status: '已完成', count: 12, color: '#4CAF50' },
                    { status: '已取消', count: 2, color: '#f44336' }
                ];
                
                // 更新图表
                updateStatusChart(statusData);
                
            } catch (error) {
                console.error('加载状态分布失败:', error);
            }
        }
        
        async function loadAlerts(shopId) {
            try {
                // 模拟告警数据
                const mockAlerts = [
                    {
                        id: 1,
                        shop_id: shopId,
                        type: 'warning',
                        title: '订单处理较慢',
                        description: '有3个新订单等待超过10分钟未处理',
                        timestamp: new Date(Date.now() - 15 * 60000).toISOString(),
                        acknowledged: false
                    },
                    {
                        id: 2,
                        shop_id: shopId,
                        type: 'critical',
                        title: '收款码未上传',
                        description: '商家尚未上传微信收款码，顾客无法付款',
                        timestamp: new Date(Date.now() - 2 * 3600 * 1000).toISOString(),
                        acknowledged: true
                    },
                    {
                        id: 3,
                        shop_id: shopId,
                        type: 'info',
                        title: '系统连接正常',
                        description: 'Supabase连接稳定，订单实时同步中',
                        timestamp: new Date(Date.now() - 5 * 60000).toISOString(),
                        acknowledged: true
                    }
                ];
                
                alerts = mockAlerts;
                renderAlerts();
                
            } catch (error) {
                console.error('加载告警失败:', error);
            }
        }
        
        // ============================================
        // 实时订阅函数
        // ============================================
        function startRealtimeSubscription(shopId) {
            // 清除之前的订阅
            stopRealtimeSubscriptions();
            
            if (!supabaseClient || !shopId) return;
            
            try {
                console.log(`📡 启动实时订阅: ${shopId}`);
                
                // 订阅订单变化
                const ordersSubscription = supabaseClient
                    .channel(`orders-${shopId}`)
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'orders',
                            filter: `tenant_id=eq.${shopId}`
                        }, 
                        (payload) => {
                            console.log('📡 订单变化:', payload);
                            handleOrderUpdate(payload);
                        }
                    )
                    .subscribe();
                
                realtimeSubscriptions.push(ordersSubscription);
                
                console.log('✅ 实时订阅已启动');
                
            } catch (error) {
                console.error('❌ 启动实时订阅失败:', error);
            }
        }
        
        function stopRealtimeSubscriptions() {
            realtimeSubscriptions.forEach(sub => {
                if (sub && supabaseClient) {
                    supabaseClient.removeChannel(sub);
                }
            });
            realtimeSubscriptions = [];
        }
        
        function handleOrderUpdate(payload) {
            // 显示实时更新指示器
            showRealtimeIndicator(true);
            
            // 更新相关数据
            if (payload.new && payload.new.tenant_id === currentShopId) {
                // 刷新商家数据
                loadShopData(currentShopId);
                
                // 添加新订单通知
                if (payload.eventType === 'INSERT' && payload.new.status === '新订单') {
                    addNewAlert({
                        type: 'info',
                        title: '新订单到达',
                        description: `订单号: ${payload.new.order_number}`,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            // 隐藏指示器
            setTimeout(() => showRealtimeIndicator(false), 2000);
        }
        
        // ============================================
        // 图表函数
        // ============================================
        function initCharts() {
            // 初始化订单趋势图表
            const ordersCtx = document.getElementById('ordersChart');
            if (ordersCtx && ordersCtx.getContext) {
                ordersCtx.innerHTML = '<canvas id="ordersChartCanvas" width="400" height="300"></canvas>';
                
                const canvas = document.getElementById('ordersChartCanvas');
                const ctx = canvas.getContext('2d');
                
                charts.ordersChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '订单数量',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 10)),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '订单数'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            }
                        }
                    }
                });
            }
            
            // 初始化状态分布图表
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx && statusCtx.getContext) {
                statusCtx.innerHTML = '<canvas id="statusChartCanvas" width="300" height="300"></canvas>';
                
                const canvas = document.getElementById('statusChartCanvas');
                const ctx = canvas.getContext('2d');
                
                charts.statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['新订单', '处理中', '已完成', '已取消'],
                        datasets: [{
                            data: [5, 3, 12, 2],
                            backgroundColor: [
                                '#667eea',
                                '#ff9800',
                                '#4CAF50',
                                '#f44336'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }
        
        function updateOrdersChart(data) {
            if (charts.ordersChart && data) {
                charts.ordersChart.data.datasets[0].data = data.map(d => d.orders);
                charts.ordersChart.update();
            }
        }
        
        function updateStatusChart(data) {
            if (charts.statusChart && data) {
                charts.statusChart.data.labels = data.map(d => d.status);
                charts.statusChart.data.datasets[0].data = data.map(d => d.count);
                charts.statusChart.data.datasets[0].backgroundColor = data.map(d => d.color);
                charts.statusChart.update();
            }
        }
        
        // ============================================
        // 告警管理函数
        // ============================================
        function renderAlerts() {
            const alertsList = document.getElementById('alertsList');
            if (!alertsList) return;
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-placeholder" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>当前无告警信息</p>
                    </div>
                `;
                return;
            }
            
            // 按时间排序（最新的在前）
            const sortedAlerts = [...alerts].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            alertsList.innerHTML = sortedAlerts.map(alert => `
                <div class="alert-item ${alert.type}">
                    <div class="alert-info">
                        <div class="alert-title">
                            <i class="fas fa-${getAlertIcon(alert.type)}"></i>
                            ${alert.title}
                        </div>
                        <div class="alert-desc">${alert.description}</div>
                    </div>
                    <div class="alert-time">${formatTime(alert.timestamp)}</div>
                    ${!alert.acknowledged ? `
                    <div class="alert-actions">
                        <button class="btn-acknowledge" onclick="acknowledgeAlert(${alert.id})">
                            已处理
                        </button>
                        <button class="btn-silence" onclick="silenceAlert(${alert.id})">
                            忽略
                        </button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
            
            // 更新活跃告警数
            const activeAlerts = alerts.filter(a => !a.acknowledged).length;
            document.getElementById('activeAlerts').textContent = activeAlerts;
            document.getElementById('cardAlerts').textContent = activeAlerts;
        }
        
        function addNewAlert(alert) {
            const newAlert = {
                id: Date.now(),
                shop_id: currentShopId,
                ...alert,
                acknowledged: false
            };
            
            alerts.unshift(newAlert);
            
            // 限制最多保存50条告警
            if (alerts.length > 50) {
                alerts.pop();
            }
            
            renderAlerts();
            
            // 显示桌面通知（如果浏览器支持）
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`监控告警: ${alert.title}`, {
                    body: alert.description,
                    icon: '/favicon.ico'
                });
            }
        }
        
        function acknowledgeAlert(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (alert) {
                alert.acknowledged = true;
                renderAlerts();
            }
        }
        
        function silenceAlert(alertId) {
            alerts = alerts.filter(a => a.id !== alertId);
            renderAlerts();
        }
        
        function filterAlerts(filter) {
            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 实际应用中应该根据filter筛选告警
            // 这里只是简单示例
            renderAlerts();
        }
        
        // ============================================
        // 系统统计函数
        // ============================================
        function updateSystemStats() {
            // 更新总商家数
            document.getElementById('totalShops').textContent = shops.length;
            
            // 计算在线商家数（模拟）
            const onlineShops = shops.filter(s => s.is_active !== false).length;
            document.getElementById('activeShops').textContent = onlineShops;
            
            // 更新最后更新时间
            document.getElementById('lastUpdate').textContent = 
                `最后更新: ${formatTime(new Date().toISOString())}`;
        }
        
        function updateMonitorCards() {
            const stats = window.todayStats || { total: 0, pending: 0, revenue: 0 };
            
            document.getElementById('cardOrders').textContent = stats.total;
            document.getElementById('cardRevenue').textContent = '¥' + stats.revenue.toFixed(2);
            document.getElementById('cardWaiting').textContent = stats.pending;
            
            // 计算平均等待时间（模拟）
            const avgWaitTime = stats.pending > 0 ? Math.floor(Math.random() * 10) + 5 : 0;
            document.getElementById('avgWaitTime').textContent = avgWaitTime;
            
            // 更新趋势（模拟）
            document.getElementById('todayOrders').textContent = stats.total;
            document.getElementById('totalRevenue').textContent = '¥' + stats.revenue.toFixed(2);
        }
        
        // ============================================
        // 工具函数
        // ============================================
        function getMockShops() {
            return [
                {
                    id: 'default_shop',
                    tenant_id: 'default_shop',
                    name: '我的摊位',
                    shop_type: 'food',
                    theme_color: '#E63946',
                    is_active: true,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'laowang',
                    tenant_id: '老王煎饼',
                    name: '老王煎饼',
                    shop_type: 'food',
                    theme_color: '#FF6B35',
                    is_active: true,
                    created_at: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'xiaoli',
                    tenant_id: '小李烧烤',
                    name: '小李烧烤',
                    shop_type: 'food',
                    theme_color: '#FF9A00',
                    is_active: true,
                    created_at: new Date(Date.now() - 172800000).toISOString()
                }
            ];
        }
        
        function getAlertIcon(type) {
            switch (type) {
                case 'critical': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                default: return 'bell';
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // 1分钟内
                return '刚刚';
            } else if (diff < 3600000) { // 1小时内
                return Math.floor(diff / 60000) + '分钟前';
            } else if (diff < 86400000) { // 24小时内
                return Math.floor(diff / 3600000) + '小时前';
            } else {
                return date.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
        
        function showRealtimeIndicator(show) {
            const indicator = document.getElementById('realtimeIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
        }
        
        // ============================================
        // 页面操作函数
        // ============================================
        function refreshShops() {
            console.log('🔄 刷新商家列表...');
            loadAllShops();
        }
        
        function refreshShopData() {
            if (currentShopId) {
                console.log(`🔄 刷新商家数据: ${currentShopId}`);
                loadShopData(currentShopId);
            }
        }
        
        function openShopAdmin() {
            if (currentShopId) {
                const adminUrl = `${window.location.origin}/admin.html?shop=${currentShopId}`;
                window.open(adminUrl, '_blank');
            }
        }
        
        function startAutoRefresh() {
            // 每分钟刷新一次数据
            refreshInterval = setInterval(() => {
                if (currentShopId) {
                    loadShopData(currentShopId);
                }
            }, 60000); // 60秒
            
            console.log('⏰ 自动刷新已启动，间隔60秒');
        }
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            stopRealtimeSubscriptions();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // 请求通知权限
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>