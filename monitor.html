<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€ç›‘æ§å‘Šè­¦ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .monitor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .monitor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .system-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.warning {
            background: #ff9800;
        }
        
        .status-dot.danger {
            background: #f44336;
        }
        
        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .monitor-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        /* å·¦ä¾§å•†å®¶åˆ—è¡¨ */
        .shops-sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .shops-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .shops-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .shop-item {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .shop-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .shop-item.active {
            border-color: #667eea;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.1), transparent);
        }
        
        .shop-name {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shop-status {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .shop-status.online { background: #4CAF50; }
        .shop-status.offline { background: #f44336; }
        .shop-status.warning { background: #ff9800; }
        
        .shop-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        /* å³ä¾§ç›‘æ§é¢æ¿ */
        .monitor-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .selected-shop {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .shop-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .shop-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .shop-info p {
            font-size: 12px;
            color: #666;
        }
        
        /* ç›‘æ§å¡ç‰‡ */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .monitor-card {
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .card-orders {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .card-revenue {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }
        
        .card-waiting {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .card-alerts {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .card-trend {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }
        
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            border: 2px dashed #eee;
            border-radius: 8px;
        }
        
        /* å‘Šè­¦åˆ—è¡¨ */
        .alerts-section {
            margin-top: 30px;
        }
        
        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .alert-filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }
        
        .alert-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .alert-item.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .alert-info {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-desc {
            font-size: 12px;
            color: #666;
        }
        
        .alert-time {
            font-size: 11px;
            color: #999;
            white-space: nowrap;
            margin-left: 15px;
        }
        
        .alert-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-acknowledge {
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .btn-silence {
            padding: 4px 10px;
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        /* å®æ—¶æŒ‡ç¤ºå™¨ */
        .realtime-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 10px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            z-index: 1000;
        }
        
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }
        
        /* åŠ¨ç”» */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .monitor-content {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .shops-sidebar {
                max-height: 300px;
            }
        }
        
        /* æ–°å¢ï¼šæœåŠ¡æ—¶é—´ç®¡ç†æ ·å¼ */
        .service-time-management {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .service-time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .service-time-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .time-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .time-card.expired {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .time-card.active {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .time-card.upcoming {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .time-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .time-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .time-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-expired {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .service-time-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .duration-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .duration-btn {
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .duration-btn:hover {
            border-color: #667eea;
            background: #f0f5ff;
        }
        
        .duration-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .service-time-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .btn-danger {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        /* æ–°å¢ï¼šæœåŠ¡æ—¶é—´æé†’æ ·å¼ */
        .service-alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .service-alert.warning {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            color: #856404;
        }
        
        .service-alert.danger {
            background: #f8d7da;
            border-left: 4px solid #f44336;
            color: #721c24;
        }
        
        .service-alert.success {
            background: #d4edda;
            border-left: 4px solid #4CAF50;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="monitor-container">
        <!-- å¤´éƒ¨ -->
        <div class="monitor-header">
            <div class="header-top">
                <div class="header-title">
                    <i class="fas fa-tachometer-alt"></i> ç»Ÿä¸€ç›‘æ§å‘Šè­¦ç³»ç»Ÿ
                </div>
                <div class="system-status">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                    </div>
                    <span id="lastUpdate">æœ€åæ›´æ–°: -</span>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalShops">0</div>
                    <div class="stat-label">æ€»å•†å®¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeShops">0</div>
                    <div class="stat-label">åœ¨çº¿å•†å®¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayOrders">0</div>
                    <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">Â¥0</div>
                    <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="expiredShops">0</div>
                    <div class="stat-label">æœåŠ¡åˆ°æœŸ</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="monitor-content">
            <!-- å·¦ä¾§å•†å®¶åˆ—è¡¨ -->
            <div class="shops-sidebar">
                <div class="shops-header">
                    <h3><i class="fas fa-store"></i> å•†å®¶åˆ—è¡¨</h3>
                    <button onclick="refreshShops()" style="background: none; border: none; color: #667eea; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="shops-list" id="shopsList">
                    <!-- åŠ¨æ€åŠ è½½å•†å®¶ -->
                    <div class="shop-loading" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½å•†å®¶åˆ—è¡¨...
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ç›‘æ§é¢æ¿ -->
            <div class="monitor-panel">
                <div class="panel-header">
                    <div class="selected-shop">
                        <div class="shop-avatar" id="selectedShopAvatar">?</div>
                        <div class="shop-info">
                            <h3 id="selectedShopName">è¯·é€‰æ‹©å•†å®¶</h3>
                            <p id="selectedShopId">-</p>
                        </div>
                    </div>
                    
                    <div class="panel-actions">
                        <button onclick="openShopAdmin()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            <i class="fas fa-external-link-alt"></i> è¿›å…¥åå°
                        </button>
                        <button onclick="refreshShopData()" style="padding: 8px 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                </div>
                
                <!-- æœåŠ¡æ—¶é—´ç®¡ç† -->
                <div class="service-time-management" id="serviceTimeManagement" style="display: none;">
                    <div class="service-time-header">
                        <h3><i class="fas fa-clock"></i> æœåŠ¡æ—¶é—´ç®¡ç†</h3>
                        <div id="serviceStatusDisplay"></div>
                    </div>
                    
                    <!-- æœåŠ¡æ—¶é—´æé†’ -->
                    <div id="serviceAlert" class="service-alert" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <div id="serviceAlertMessage"></div>
                    </div>
                    
                    <!-- å½“å‰æœåŠ¡æ—¶é—´æ˜¾ç¤º -->
                    <div class="service-time-display" id="serviceTimeDisplay">
                        <div class="time-card" id="startTimeCard">
                            <div class="time-label">æœåŠ¡å¼€å§‹æ—¶é—´</div>
                            <div class="time-value" id="startTimeValue">æœªè®¾ç½®</div>
                            <div class="time-status status-pending" id="startTimeStatus">å¾…è®¾ç½®</div>
                        </div>
                        
                        <div class="time-card" id="endTimeCard">
                            <div class="time-label">æœåŠ¡ç»“æŸæ—¶é—´</div>
                            <div class="time-value" id="endTimeValue">æœªè®¾ç½®</div>
                            <div class="time-status status-pending" id="endTimeStatus">å¾…è®¾ç½®</div>
                        </div>
                    </div>
                    
                    <!-- å‰©ä½™æ—¶é—´ -->
                    <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å‰©ä½™æœåŠ¡æ—¶é—´</div>
                        <div style="font-size: 24px; font-weight: 600; color: #333;" id="remainingTime">æœªè®¾ç½®</div>
                    </div>
                    
                    <!-- è®¾ç½®æœåŠ¡æ—¶é—´è¡¨å• -->
                    <div class="service-time-form">
                        <h4 style="margin-bottom: 15px; color: #333;">è®¾ç½®æœåŠ¡æ—¶é—´</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceStartDate">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="serviceStartDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="serviceStartTime">å¼€å§‹æ—¶é—´</label>
                                <input type="time" id="serviceStartTime" class="form-control" value="09:00">
                            </div>
                        </div>
                        
                        <div class="duration-options">
                            <div class="duration-btn" onclick="setDuration(7)">7å¤©</div>
                            <div class="duration-btn" onclick="setDuration(30)" style="background: #667eea; color: white;">30å¤©</div>
                            <div class="duration-btn" onclick="setDuration(90)">90å¤©</div>
                            <div class="duration-btn" onclick="setDuration(180)">180å¤©</div>
                            <div class="duration-btn" onclick="setDuration(365)">365å¤©</div>
                            <div class="duration-btn" onclick="setCustomDuration()">è‡ªå®šä¹‰</div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceDuration">æœåŠ¡æ—¶é•¿ï¼ˆå¤©ï¼‰</label>
                                <input type="number" id="serviceDuration" class="form-control" value="30" min="1" max="3650">
                            </div>
                            <div class="form-group">
                                <label for="serviceEndDate">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="serviceEndDate" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="service-time-actions">
                            <button class="btn-primary" onclick="saveServiceTime()">
                                <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                            </button>
                            <button class="btn-secondary" onclick="clearServiceTime()">
                                <i class="fas fa-times"></i> æ¸…é™¤æœåŠ¡æ—¶é—´
                            </button>
                            <button class="btn-danger" onclick="disableService()" id="disableServiceBtn" style="display: none;">
                                <i class="fas fa-ban"></i> ç¦ç”¨æœåŠ¡
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç›‘æ§å¡ç‰‡ -->
                <div class="monitor-grid">
                    <div class="monitor-card card-orders">
                        <div class="card-title">
                            <i class="fas fa-clipboard-list"></i> ä»Šæ—¥è®¢å•
                        </div>
                        <div class="card-value" id="cardOrders">0</div>
                        <div class="card-trend" id="ordersTrend">
                            <i class="fas fa-arrow-up"></i> 0% å¯¹æ¯”æ˜¨æ—¥
                        </div>
                    </div>
                    
                    <div class="monitor-card card-revenue">
                        <div class="card-title">
                            <i class="fas fa-yen-sign"></i> ä»Šæ—¥è¥æ”¶
                        </div>
                        <div class="card-value" id="cardRevenue">Â¥0</div>
                        <div class="card-trend" id="revenueTrend">
                            <i class="fas fa-arrow-up"></i> 0% å¯¹æ¯”æ˜¨æ—¥
                        </div>
                    </div>
                    
                    <div class="monitor-card card-waiting">
                        <div class="card-title">
                            <i class="fas fa-clock"></i> ç­‰å¾…å¤„ç†
                        </div>
                        <div class="card-value" id="cardWaiting">0</div>
                        <div class="card-trend">
                            å¹³å‡ç­‰å¾…: <span id="avgWaitTime">0</span>åˆ†é’Ÿ
                        </div>
                    </div>
                    
                    <div class="monitor-card card-alerts">
                        <div class="card-title">
                            <i class="fas fa-exclamation-triangle"></i> æœåŠ¡çŠ¶æ€
                        </div>
                        <div class="card-value" id="cardAlerts">æ­£å¸¸</div>
                        <div class="card-trend" id="alertsTrend">
                            æœåŠ¡ä¸­
                        </div>
                    </div>
                </div>
                
                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i> ä»Šæ—¥è®¢å•è¶‹åŠ¿
                            </div>
                            <select id="timeRange" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="today">ä»Šæ—¥</option>
                                <option value="yesterday">æ˜¨æ—¥</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="month">æœ¬æœˆ</option>
                            </select>
                        </div>
                        <div class="chart-placeholder" id="ordersChart">
                            è®¢å•è¶‹åŠ¿å›¾è¡¨åŒºåŸŸ
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i> è®¢å•çŠ¶æ€åˆ†å¸ƒ
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                å®æ—¶æ›´æ–°
                            </div>
                        </div>
                        <div class="chart-placeholder" id="statusChart">
                            è®¢å•çŠ¶æ€åˆ†å¸ƒå›¾è¡¨åŒºåŸŸ
                        </div>
                    </div>
                </div>
                
                <!-- å‘Šè­¦åˆ—è¡¨ -->
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3><i class="fas fa-bell"></i> å®æ—¶å‘Šè­¦</h3>
                        <div class="alert-filters">
                            <button class="filter-btn active" onclick="filterAlerts('all')">å…¨éƒ¨</button>
                            <button class="filter-btn" onclick="filterAlerts('warning')">è­¦å‘Š</button>
                            <button class="filter-btn" onclick="filterAlerts('critical')">ä¸¥é‡</button>
                            <button class="filter-btn" onclick="filterAlerts('resolved')">å·²è§£å†³</button>
                        </div>
                    </div>
                    
                    <div class="alerts-list" id="alertsList">
                        <div class="alert-placeholder" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                            <p>å½“å‰æ— å‘Šè­¦ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æŒ‡ç¤ºå™¨ -->
        <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
            <div class="pulse-dot"></div>
            <span>å®æ—¶æ›´æ–°ä¸­...</span>
        </div>
    </div>

    <!-- å¼•å…¥å›¾è¡¨åº“ï¼ˆå®é™…ä½¿ç”¨æ—¶å¯å¼•å…¥EChartsæˆ–Chart.jsï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <script>
        // ============================================
        // å…¨å±€å˜é‡å’Œé…ç½®
        // ============================================
        const SUPABASE_URL = 'https://slonbvmhsxqgpoodwazj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb25idm1oc3hxZ3Bvb2R3YXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzMyNjQsImV4cCI6MjA4NDYwOTI2NH0.YLZqdnZl1vDTOrT6bzi2ulN1BGRxKGyW30AuccuWJq4';
        
        let supabaseClient = null;
        let currentShopId = null;
        let shops = [];
        let alerts = [];
        let realtimeSubscriptions = [];
        let charts = {};
        let refreshInterval = null;
        let currentShopServiceInfo = null;
        
        // ============================================
        // åˆå§‹åŒ–å‡½æ•°
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ ç»Ÿä¸€ç›‘æ§ç³»ç»Ÿåˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // åŠ è½½æ‰€æœ‰å•†å®¶
            await loadAllShops();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            
            console.log('âœ… ç›‘æ§ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        });
        
        // ============================================
        // å•†å®¶ç®¡ç†å‡½æ•°
        // ============================================
        async function loadAllShops() {
            try {
                console.log('ğŸ“‹ åŠ è½½å•†å®¶åˆ—è¡¨...');
                
                // 1. é¦–å…ˆå°è¯•ä»SupabaseåŠ è½½
                const { data: supabaseShops, error } = await supabaseClient
                    .from('shops')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.warn('âš ï¸ ä»SupabaseåŠ è½½å•†å®¶å¤±è´¥:', error.message);
                    
                    // 2. å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                    const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
                    
                    if (Object.keys(localShops).length > 0) {
                        console.log('ğŸ“ ä»æœ¬åœ°å­˜å‚¨åŠ è½½å•†å®¶:', Object.keys(localShops).length);
                        shops = Object.values(localShops);
                        renderShopsList();
                        updateSystemStats();
                        return;
                    }
                    
                    // 3. ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    console.log('ğŸ“ ä½¿ç”¨æ¨¡æ‹Ÿå•†å®¶æ•°æ®');
                    shops = getMockShops();
                    
                } else if (supabaseShops && supabaseShops.length > 0) {
                    console.log('âœ… ä»SupabaseåŠ è½½å•†å®¶:', supabaseShops.length);
                    shops = supabaseShops;
                    
                } else {
                    // æ²¡æœ‰å•†å®¶æ•°æ®ï¼Œä»æœ¬åœ°å­˜å‚¨è·å–
                    const localShops = JSON.parse(localStorage.getItem('registered_shops') || '{}');
                    if (Object.keys(localShops).length > 0) {
                        shops = Object.values(localShops);
                    } else {
                        shops = getMockShops();
                    }
                }
                
                // æ¸²æŸ“å•†å®¶åˆ—è¡¨
                renderShopsList();
                
                // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡
                updateSystemStats();
                
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå•†å®¶
                if (shops.length > 0 && !currentShopId) {
                    selectShop(shops[0].tenant_id || shops[0].id);
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½å•†å®¶åˆ—è¡¨å¤±è´¥:', error);
                shops = getMockShops();
                renderShopsList();
                updateSystemStats();
            }
        }
        
        function renderShopsList() {
            const shopsList = document.getElementById('shopsList');
            if (!shopsList) return;
            
            if (shops.length === 0) {
                shopsList.innerHTML = `
                    <div class="shop-empty" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-store-slash" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>æš‚æ— å•†å®¶æ•°æ®</p>
                        <button onclick="window.open('register.html', '_blank')" style="margin-top: 15px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-plus"></i> æ·»åŠ æ–°å•†å®¶
                        </button>
                    </div>
                `;
                return;
            }
            
            shopsList.innerHTML = shops.map(shop => {
                const shopId = shop.tenant_id || shop.id;
                const isActive = shop.is_active !== false;
                const isSelected = shopId === currentShopId;
                
                // æ£€æŸ¥æœåŠ¡æ—¶é—´çŠ¶æ€
                const serviceStatus = checkServiceStatus(shop);
                const statusText = getServiceStatusText(serviceStatus);
                const statusClass = getServiceStatusClass(serviceStatus);
                
                return `
                <div class="shop-item ${isSelected ? 'active' : ''}" onclick="selectShop('${shopId}')">
                    <div class="shop-name">
                        <i class="fas fa-${shop.shop_type === 'drink' ? 'wine-glass' : 'utensils'}"></i>
                        ${shop.name}
                    </div>
                    <div class="shop-meta">
                        <span>${formatDate(shop.created_at)}</span>
                        <span class="${statusClass}">${statusText}</span>
                    </div>
                    <div class="shop-status ${statusClass === 'status-active' ? 'online' : statusClass === 'status-expired' ? 'offline' : 'warning'}"></div>
                </div>
                `;
            }).join('');
        }
        
        function checkServiceStatus(shop) {
            const now = new Date();
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®æœåŠ¡æ—¶é—´
            if (!shop.service_start_time || !shop.service_end_time) {
                return 'not_set';
            }
            
            const startTime = new Date(shop.service_start_time);
            const endTime = new Date(shop.service_end_time);
            
            if (now < startTime) {
                return 'not_started';
            } else if (now > endTime) {
                return 'expired';
            } else {
                return 'active';
            }
        }
        
        function getServiceStatusText(status) {
            switch (status) {
                case 'not_set': return 'æœªè®¾ç½®';
                case 'not_started': return 'æœªå¼€å§‹';
                case 'active': return 'æœåŠ¡ä¸­';
                case 'expired': return 'å·²è¿‡æœŸ';
                default: return 'æœªçŸ¥';
            }
        }
        
        function getServiceStatusClass(status) {
            switch (status) {
                case 'active': return 'status-active';
                case 'expired': return 'status-expired';
                case 'not_set':
                case 'not_started':
                default: return 'status-pending';
            }
        }
        
        function selectShop(shopId) {
            console.log('ğŸª é€‰æ‹©å•†å®¶:', shopId);
            currentShopId = shopId;
            
            // æ›´æ–°UI
            renderShopsList();
            updateSelectedShopDisplay();
            
            // åŠ è½½å•†å®¶æ•°æ®
            loadShopData(shopId);
            
            // åŠ è½½æœåŠ¡æ—¶é—´ä¿¡æ¯
            loadServiceTimeInfo(shopId);
            
            // å¼€å§‹å®æ—¶è®¢é˜…
            startRealtimeSubscription(shopId);
        }
        
        function updateSelectedShopDisplay() {
            const shop = shops.find(s => (s.tenant_id || s.id) === currentShopId);
            if (!shop) return;
            
            document.getElementById('selectedShopName').textContent = shop.name;
            document.getElementById('selectedShopId').textContent = shop.tenant_id || shop.id;
            
            // æ›´æ–°å¤´åƒ
            const avatar = document.getElementById('selectedShopAvatar');
            avatar.textContent = shop.name.charAt(0).toUpperCase();
            avatar.style.background = shop.theme_color || `linear-gradient(135deg, #667eea, #764ba2)`;
        }
        
        // ============================================
        // æœåŠ¡æ—¶é—´ç®¡ç†å‡½æ•°
        // ============================================
        async function loadServiceTimeInfo(shopId) {
            try {
                console.log('â° åŠ è½½æœåŠ¡æ—¶é—´ä¿¡æ¯:', shopId);
                
                const shop = shops.find(s => (s.tenant_id || s.id) === shopId);
                if (!shop) {
                    console.warn('æœªæ‰¾åˆ°å•†å®¶ä¿¡æ¯:', shopId);
                    return;
                }
                
                currentShopServiceInfo = shop;
                
                // æ˜¾ç¤ºæœåŠ¡æ—¶é—´ç®¡ç†é¢æ¿
                document.getElementById('serviceTimeManagement').style.display = 'block';
                
                // æ›´æ–°æœåŠ¡æ—¶é—´æ˜¾ç¤º
                updateServiceTimeDisplay(shop);
                
                // è®¾ç½®è¡¨å•é»˜è®¤å€¼
                setupServiceTimeForm();
                
            } catch (error) {
                console.error('âŒ åŠ è½½æœåŠ¡æ—¶é—´ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        function updateServiceTimeDisplay(shop) {
            const now = new Date();
            let startTime = 'æœªè®¾ç½®';
            let endTime = 'æœªè®¾ç½®';
            let remainingTime = 'æœªè®¾ç½®';
            let status = 'not_set';
            let statusText = 'æœªè®¾ç½®æœåŠ¡æ—¶é—´';
            let statusClass = 'status-pending';
            
            if (shop.service_start_time && shop.service_end_time) {
                const startDate = new Date(shop.service_start_time);
                const endDate = new Date(shop.service_end_time);
                
                startTime = formatDateTime(shop.service_start_time);
                endTime = formatDateTime(shop.service_end_time);
                
                // è®¡ç®—å‰©ä½™æ—¶é—´
                if (now < endDate) {
                    const diffMs = endDate - now;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    if (diffDays > 0) {
                        remainingTime = `${diffDays}å¤©${diffHours}å°æ—¶`;
                    } else {
                        remainingTime = `${diffHours}å°æ—¶`;
                    }
                }
                
                // ç¡®å®šçŠ¶æ€
                if (now < startDate) {
                    status = 'not_started';
                    statusText = 'æœåŠ¡æœªå¼€å§‹';
                    statusClass = 'status-pending';
                } else if (now > endDate) {
                    status = 'expired';
                    statusText = 'æœåŠ¡å·²è¿‡æœŸ';
                    statusClass = 'status-expired';
                } else {
                    status = 'active';
                    statusText = 'æœåŠ¡ä¸­';
                    statusClass = 'status-active';
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('startTimeValue').textContent = startTime;
            document.getElementById('endTimeValue').textContent = endTime;
            document.getElementById('remainingTime').textContent = remainingTime;
            
            // æ›´æ–°çŠ¶æ€
            document.getElementById('startTimeStatus').textContent = statusText;
            document.getElementById('startTimeStatus').className = `time-status ${statusClass}`;
            document.getElementById('endTimeStatus').textContent = statusText;
            document.getElementById('endTimeStatus').className = `time-status ${statusClass}`;
            
            // æ›´æ–°å¡ç‰‡æ ·å¼
            const startTimeCard = document.getElementById('startTimeCard');
            const endTimeCard = document.getElementById('endTimeCard');
            
            startTimeCard.className = 'time-card';
            endTimeCard.className = 'time-card';
            
            if (status === 'active') {
                startTimeCard.classList.add('active');
                endTimeCard.classList.add('active');
            } else if (status === 'expired') {
                startTimeCard.classList.add('expired');
                endTimeCard.classList.add('expired');
            } else if (status === 'not_started') {
                startTimeCard.classList.add('upcoming');
                endTimeCard.classList.add('upcoming');
            }
            
            // æ›´æ–°æœåŠ¡çŠ¶æ€æ˜¾ç¤º
            document.getElementById('serviceStatusDisplay').innerHTML = `
                <span class="${statusClass}" style="padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                    ${statusText}
                </span>
            `;
            
            // æ˜¾ç¤ºæˆ–éšè—ç¦ç”¨æŒ‰é’®
            const disableBtn = document.getElementById('disableServiceBtn');
            if (status === 'active') {
                disableBtn.style.display = 'inline-block';
            } else {
                disableBtn.style.display = 'none';
            }
            
            // æ˜¾ç¤ºæé†’
            showServiceAlert(status, statusText);
        }
        
        function setupServiceTimeForm() {
            // è®¾ç½®å¼€å§‹æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('serviceStartDate').value = formattedDate;
            
            // è®¡ç®—ç»“æŸæ—¥æœŸï¼ˆé»˜è®¤30å¤©ï¼‰
            calculateEndDate();
            
            // å¦‚æœæœ‰ç°æœ‰æœåŠ¡æ—¶é—´ï¼Œå¡«å……è¡¨å•
            if (currentShopServiceInfo && currentShopServiceInfo.service_start_time) {
                const startDate = new Date(currentShopServiceInfo.service_start_time);
                const endDate = new Date(currentShopServiceInfo.service_end_time);
                
                // è®¡ç®—å¤©æ•°å·®
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('serviceStartDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('serviceStartTime').value = formatTimeForInput(startDate);
                document.getElementById('serviceDuration').value = diffDays;
                
                const endDateStr = endDate.toISOString().split('T')[0];
                document.getElementById('serviceEndDate').value = endDateStr;
            }
        }
        
        function calculateEndDate() {
            const startDateInput = document.getElementById('serviceStartDate').value;
            const startTimeInput = document.getElementById('serviceStartTime').value;
            const durationInput = document.getElementById('serviceDuration').value;
            
            if (!startDateInput || !durationInput) return;
            
            // åˆ›å»ºå¼€å§‹æ—¶é—´
            const startDateTime = new Date(`${startDateInput}T${startTimeInput}`);
            
            // è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆæ·»åŠ å¤©æ•°ï¼‰
            const endDateTime = new Date(startDateTime);
            endDateTime.setDate(endDateTime.getDate() + parseInt(durationInput));
            
            // è®¾ç½®ç»“æŸæ—¥æœŸ
            const endDateStr = endDateTime.toISOString().split('T')[0];
            document.getElementById('serviceEndDate').value = endDateStr;
        }
        
        function setDuration(days) {
            document.getElementById('serviceDuration').value = days;
            calculateEndDate();
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const buttons = document.querySelectorAll('.duration-btn');
            buttons.forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#495057';
            });
            
            // æ‰¾åˆ°è¢«ç‚¹å‡»çš„æŒ‰é’®
            if (event && event.target) {
                event.target.style.background = '#667eea';
                event.target.style.color = 'white';
            }
        }
        
        function setCustomDuration() {
            const customDays = prompt('è¯·è¾“å…¥è‡ªå®šä¹‰å¤©æ•°ï¼ˆ1-3650ï¼‰:', '30');
            if (customDays && !isNaN(customDays) && customDays >= 1 && customDays <= 3650) {
                document.getElementById('serviceDuration').value = parseInt(customDays);
                calculateEndDate();
                
                // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
                const buttons = document.querySelectorAll('.duration-btn');
                buttons.forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.color = '#495057';
                });
            }
        }
        
        async function saveServiceTime() {
            try {
                const shopId = currentShopId;
                const startDateInput = document.getElementById('serviceStartDate').value;
                const startTimeInput = document.getElementById('serviceStartTime').value;
                const durationInput = document.getElementById('serviceDuration').value;
                
                if (!startDateInput || !startTimeInput || !durationInput) {
                    showServiceAlert('warning', 'è¯·å¡«å†™å®Œæ•´çš„æœåŠ¡æ—¶é—´ä¿¡æ¯');
                    return;
                }
                
                // åˆ›å»ºå¼€å§‹æ—¶é—´
                const startDateTime = new Date(`${startDateInput}T${startTimeInput}`);
                
                // åˆ›å»ºç»“æŸæ—¶é—´
                const endDateTime = new Date(startDateTime);
                endDateTime.setDate(endDateTime.getDate() + parseInt(durationInput));
                
                console.log('ğŸ’¾ ä¿å­˜æœåŠ¡æ—¶é—´:', {
                    shopId: shopId,
                    startTime: startDateTime.toISOString(),
                    endTime: endDateTime.toISOString(),
                    duration: durationInput
                });
                
                // æ›´æ–°Supabase
                const { error } = await supabaseClient
                    .from('shops')
                    .update({
                        service_start_time: startDateTime.toISOString(),
                        service_end_time: endDateTime.toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('tenant_id', shopId);
                
                if (error) {
                    console.error('âŒ ä¿å­˜æœåŠ¡æ—¶é—´å¤±è´¥:', error);
                    showServiceAlert('danger', 'ä¿å­˜å¤±è´¥: ' + error.message);
                    return;
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const shopIndex = shops.findIndex(s => (s.tenant_id || s.id) === shopId);
                if (shopIndex !== -1) {
                    shops[shopIndex].service_start_time = startDateTime.toISOString();
                    shops[shopIndex].service_end_time = endDateTime.toISOString();
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateServiceTimeDisplay(shops[shopIndex]);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showServiceAlert('success', 'æœåŠ¡æ—¶é—´è®¾ç½®æˆåŠŸï¼');
                
                console.log('âœ… æœåŠ¡æ—¶é—´å·²ä¿å­˜');
                
            } catch (error) {
                console.error('âŒ ä¿å­˜æœåŠ¡æ—¶é—´å¤±è´¥:', error);
                showServiceAlert('danger', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        async function clearServiceTime() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æœåŠ¡æ—¶é—´å—ï¼Ÿå•†å®¶å°†æ— æ³•è®¿é—®åå°ã€‚')) {
                return;
            }
            
            try {
                const shopId = currentShopId;
                
                console.log('ğŸ—‘ï¸ æ¸…é™¤æœåŠ¡æ—¶é—´:', shopId);
                
                // æ›´æ–°Supabase
                const { error } = await supabaseClient
                    .from('shops')
                    .update({
                        service_start_time: null,
                        service_end_time: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('tenant_id', shopId);
                
                if (error) {
                    console.error('âŒ æ¸…é™¤æœåŠ¡æ—¶é—´å¤±è´¥:', error);
                    showServiceAlert('danger', 'æ¸…é™¤å¤±è´¥: ' + error.message);
                    return;
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const shopIndex = shops.findIndex(s => (s.tenant_id || s.id) === shopId);
                if (shopIndex !== -1) {
                    shops[shopIndex].service_start_time = null;
                    shops[shopIndex].service_end_time = null;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateServiceTimeDisplay(shops[shopIndex]);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showServiceAlert('success', 'æœåŠ¡æ—¶é—´å·²æ¸…é™¤');
                
                console.log('âœ… æœåŠ¡æ—¶é—´å·²æ¸…é™¤');
                
            } catch (error) {
                console.error('âŒ æ¸…é™¤æœåŠ¡æ—¶é—´å¤±è´¥:', error);
                showServiceAlert('danger', 'æ¸…é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        async function disableService() {
            if (!confirm('ç¡®å®šè¦ç¦ç”¨å•†å®¶çš„æœåŠ¡å—ï¼Ÿå•†å®¶å°†ç«‹å³æ— æ³•è®¿é—®åå°ã€‚')) {
                return;
            }
            
            try {
                const shopId = currentShopId;
                
                console.log('ğŸš« ç¦ç”¨æœåŠ¡:', shopId);
                
                // è®¾ç½®ç»“æŸæ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼ˆç«‹å³è¿‡æœŸï¼‰
                const now = new Date();
                const { error } = await supabaseClient
                    .from('shops')
                    .update({
                        service_end_time: now.toISOString(),
                        updated_at: now.toISOString()
                    })
                    .eq('tenant_id', shopId);
                
                if (error) {
                    console.error('âŒ ç¦ç”¨æœåŠ¡å¤±è´¥:', error);
                    showServiceAlert('danger', 'ç¦ç”¨å¤±è´¥: ' + error.message);
                    return;
                }
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const shopIndex = shops.findIndex(s => (s.tenant_id || s.id) === shopId);
                if (shopIndex !== -1) {
                    shops[shopIndex].service_end_time = now.toISOString();
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateServiceTimeDisplay(shops[shopIndex]);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showServiceAlert('success', 'æœåŠ¡å·²ç¦ç”¨ï¼Œå•†å®¶æ— æ³•è®¿é—®åå°');
                
                console.log('âœ… æœåŠ¡å·²ç¦ç”¨');
                
            } catch (error) {
                console.error('âŒ ç¦ç”¨æœåŠ¡å¤±è´¥:', error);
                showServiceAlert('danger', 'ç¦ç”¨å¤±è´¥: ' + error.message);
            }
        }
        
        function showServiceAlert(type, message) {
            const alertDiv = document.getElementById('serviceAlert');
            const messageDiv = document.getElementById('serviceAlertMessage');
            
            if (!alertDiv || !messageDiv) return;
            
            alertDiv.className = `service-alert ${type}`;
            messageDiv.textContent = message;
            alertDiv.style.display = 'flex';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // ============================================
        // æ•°æ®åŠ è½½å’Œå®æ—¶è®¢é˜…
        // ============================================
        async function loadShopData(shopId) {
            try {
                console.log(`ğŸ“Š åŠ è½½å•†å®¶æ•°æ®: ${shopId}`);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showRealtimeIndicator(true);
                
                // 1. åŠ è½½ä»Šæ—¥è®¢å•ç»Ÿè®¡
                await loadTodayStats(shopId);
                
                // 2. åŠ è½½è®¢å•è¶‹åŠ¿æ•°æ®
                await loadOrdersTrend(shopId);
                
                // 3. åŠ è½½è®¢å•çŠ¶æ€åˆ†å¸ƒ
                await loadStatusDistribution(shopId);
                
                // 4. åŠ è½½å‘Šè­¦æ•°æ®
                await loadAlerts(shopId);
                
                // æ›´æ–°å¡ç‰‡æ•°æ®
                updateMonitorCards();
                
                // éšè—åŠ è½½çŠ¶æ€
                setTimeout(() => showRealtimeIndicator(false), 1000);
                
            } catch (error) {
                console.error(`âŒ åŠ è½½å•†å®¶æ•°æ®å¤±è´¥:`, error);
                showRealtimeIndicator(false);
            }
        }
        
        async function loadTodayStats(shopId) {
            try {
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();
                
                // è·å–ä»Šæ—¥è®¢å•
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .eq('tenant_id', shopId)
                    .gte('created_at', todayStart)
                    .lt('created_at', todayEnd);
                
                if (error) {
                    console.warn('è·å–ä»Šæ—¥è®¢å•å¤±è´¥:', error.message);
                    return;
                }
                
                // è®¡ç®—ç»Ÿè®¡
                const totalOrders = orders ? orders.length : 0;
                const pendingOrders = orders ? orders.filter(o => o.status === 'æ–°è®¢å•').length : 0;
                const totalRevenue = orders ? orders
                    .filter(o => o.status === 'å·²å®Œæˆ')
                    .reduce((sum, o) => sum + (o.total_amount || 0), 0) : 0;
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
                window.todayStats = {
                    orders: orders || [],
                    total: totalOrders,
                    pending: pendingOrders,
                    revenue: totalRevenue
                };
                
            } catch (error) {
                console.error('åŠ è½½ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        async function loadOrdersTrend(shopId) {
            try {
                // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”ä»æ•°æ®åº“æŸ¥è¯¢ï¼‰
                const hours = Array.from({length: 24}, (_, i) => i);
                const mockData = hours.map(hour => ({
                    hour: hour,
                    orders: Math.floor(Math.random() * 10) + 1
                }));
                
                // æ›´æ–°å›¾è¡¨
                updateOrdersChart(mockData);
                
            } catch (error) {
                console.error('åŠ è½½è®¢å•è¶‹åŠ¿å¤±è´¥:', error);
            }
        }
        
        async function loadStatusDistribution(shopId) {
            try {
                // æ¨¡æ‹Ÿæ•°æ®
                const statusData = [
                    { status: 'æ–°è®¢å•', count: 5, color: '#667eea' },
                    { status: 'å¤„ç†ä¸­', count: 3, color: '#ff9800' },
                    { status: 'å·²å®Œæˆ', count: 12, color: '#4CAF50' },
                    { status: 'å·²å–æ¶ˆ', count: 2, color: '#f44336' }
                ];
                
                // æ›´æ–°å›¾è¡¨
                updateStatusChart(statusData);
                
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€åˆ†å¸ƒå¤±è´¥:', error);
            }
        }
        
        async function loadAlerts(shopId) {
            try {
                // æ¨¡æ‹Ÿå‘Šè­¦æ•°æ®
                const mockAlerts = [
                    {
                        id: 1,
                        shop_id: shopId,
                        type: 'warning',
                        title: 'è®¢å•å¤„ç†è¾ƒæ…¢',
                        description: 'æœ‰3ä¸ªæ–°è®¢å•ç­‰å¾…è¶…è¿‡10åˆ†é’Ÿæœªå¤„ç†',
                        timestamp: new Date(Date.now() - 15 * 60000).toISOString(),
                        acknowledged: false
                    },
                    {
                        id: 2,
                        shop_id: shopId,
                        type: 'critical',
                        title: 'æ”¶æ¬¾ç æœªä¸Šä¼ ',
                        description: 'å•†å®¶å°šæœªä¸Šä¼ å¾®ä¿¡æ”¶æ¬¾ç ï¼Œé¡¾å®¢æ— æ³•ä»˜æ¬¾',
                        timestamp: new Date(Date.now() - 2 * 3600 * 1000).toISOString(),
                        acknowledged: true
                    },
                    {
                        id: 3,
                        shop_id: shopId,
                        type: 'info',
                        title: 'ç³»ç»Ÿè¿æ¥æ­£å¸¸',
                        description: 'Supabaseè¿æ¥ç¨³å®šï¼Œè®¢å•å®æ—¶åŒæ­¥ä¸­',
                        timestamp: new Date(Date.now() - 5 * 60000).toISOString(),
                        acknowledged: true
                    }
                ];
                
                alerts = mockAlerts;
                renderAlerts();
                
            } catch (error) {
                console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
            }
        }
        
        // ============================================
        // å®æ—¶è®¢é˜…å‡½æ•°
        // ============================================
        function startRealtimeSubscription(shopId) {
            // æ¸…é™¤ä¹‹å‰çš„è®¢é˜…
            stopRealtimeSubscriptions();
            
            if (!supabaseClient || !shopId) return;
            
            try {
                console.log(`ğŸ“¡ å¯åŠ¨å®æ—¶è®¢é˜…: ${shopId}`);
                
                // è®¢é˜…è®¢å•å˜åŒ–
                const ordersSubscription = supabaseClient
                    .channel(`orders-${shopId}`)
                    .on('postgres_changes', 
                        { 
                            event: '*', 
                            schema: 'public', 
                            table: 'orders',
                            filter: `tenant_id=eq.${shopId}`
                        }, 
                        (payload) => {
                            console.log('ğŸ“¡ è®¢å•å˜åŒ–:', payload);
                            handleOrderUpdate(payload);
                        }
                    )
                    .subscribe();
                
                realtimeSubscriptions.push(ordersSubscription);
                
                console.log('âœ… å®æ—¶è®¢é˜…å·²å¯åŠ¨');
                
            } catch (error) {
                console.error('âŒ å¯åŠ¨å®æ—¶è®¢é˜…å¤±è´¥:', error);
            }
        }
        
        function stopRealtimeSubscriptions() {
            realtimeSubscriptions.forEach(sub => {
                if (sub && supabaseClient) {
                    supabaseClient.removeChannel(sub);
                }
            });
            realtimeSubscriptions = [];
        }
        
        function handleOrderUpdate(payload) {
            // æ˜¾ç¤ºå®æ—¶æ›´æ–°æŒ‡ç¤ºå™¨
            showRealtimeIndicator(true);
            
            // æ›´æ–°ç›¸å…³æ•°æ®
            if (payload.new && payload.new.tenant_id === currentShopId) {
                // åˆ·æ–°å•†å®¶æ•°æ®
                loadShopData(currentShopId);
                
                // æ·»åŠ æ–°è®¢å•é€šçŸ¥
                if (payload.eventType === 'INSERT' && payload.new.status === 'æ–°è®¢å•') {
                    addNewAlert({
                        type: 'info',
                        title: 'æ–°è®¢å•åˆ°è¾¾',
                        description: `è®¢å•å·: ${payload.new.order_number}`,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            // éšè—æŒ‡ç¤ºå™¨
            setTimeout(() => showRealtimeIndicator(false), 2000);
        }
        
        // ============================================
        // å›¾è¡¨å‡½æ•°
        // ============================================
        function initCharts() {
            // åˆå§‹åŒ–è®¢å•è¶‹åŠ¿å›¾è¡¨
            const ordersCtx = document.getElementById('ordersChart');
            if (ordersCtx && ordersCtx.getContext) {
                ordersCtx.innerHTML = '<canvas id="ordersChartCanvas" width="400" height="300"></canvas>';
                
                const canvas = document.getElementById('ordersChartCanvas');
                const ctx = canvas.getContext('2d');
                
                charts.ordersChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'è®¢å•æ•°é‡',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 10)),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'è®¢å•æ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´'
                                }
                            }
                        }
                    }
                });
            }
            
            // åˆå§‹åŒ–çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx && statusCtx.getContext) {
                statusCtx.innerHTML = '<canvas id="statusChartCanvas" width="300" height="300"></canvas>';
                
                const canvas = document.getElementById('statusChartCanvas');
                const ctx = canvas.getContext('2d');
                
                charts.statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æ–°è®¢å•', 'å¤„ç†ä¸­', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'],
                        datasets: [{
                            data: [5, 3, 12, 2],
                            backgroundColor: [
                                '#667eea',
                                '#ff9800',
                                '#4CAF50',
                                '#f44336'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }
        
        function updateOrdersChart(data) {
            if (charts.ordersChart && data) {
                charts.ordersChart.data.datasets[0].data = data.map(d => d.orders);
                charts.ordersChart.update();
            }
        }
        
        function updateStatusChart(data) {
            if (charts.statusChart && data) {
                charts.statusChart.data.labels = data.map(d => d.status);
                charts.statusChart.data.datasets[0].data = data.map(d => d.count);
                charts.statusChart.data.datasets[0].backgroundColor = data.map(d => d.color);
                charts.statusChart.update();
            }
        }
        
        // ============================================
        // å‘Šè­¦ç®¡ç†å‡½æ•°
        // ============================================
        function renderAlerts() {
            const alertsList = document.getElementById('alertsList');
            if (!alertsList) return;
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-placeholder" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-check-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>å½“å‰æ— å‘Šè­¦ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedAlerts = [...alerts].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            alertsList.innerHTML = sortedAlerts.map(alert => `
                <div class="alert-item ${alert.type}">
                    <div class="alert-info">
                        <div class="alert-title">
                            <i class="fas fa-${getAlertIcon(alert.type)}"></i>
                            ${alert.title}
                        </div>
                        <div class="alert-desc">${alert.description}</div>
                    </div>
                    <div class="alert-time">${formatTime(alert.timestamp)}</div>
                    ${!alert.acknowledged ? `
                    <div class="alert-actions">
                        <button class="btn-acknowledge" onclick="acknowledgeAlert(${alert.id})">
                            å·²å¤„ç†
                        </button>
                        <button class="btn-silence" onclick="silenceAlert(${alert.id})">
                            å¿½ç•¥
                        </button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
            
            // æ›´æ–°æ´»è·ƒå‘Šè­¦æ•°
            const activeAlerts = alerts.filter(a => !a.acknowledged).length;
            document.getElementById('cardAlerts').textContent = activeAlerts > 0 ? activeAlerts : 'æ­£å¸¸';
        }
        
        function addNewAlert(alert) {
            const newAlert = {
                id: Date.now(),
                shop_id: currentShopId,
                ...alert,
                acknowledged: false
            };
            
            alerts.unshift(newAlert);
            
            // é™åˆ¶æœ€å¤šä¿å­˜50æ¡å‘Šè­¦
            if (alerts.length > 50) {
                alerts.pop();
            }
            
            renderAlerts();
            
            // æ˜¾ç¤ºæ¡Œé¢é€šçŸ¥ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`ç›‘æ§å‘Šè­¦: ${alert.title}`, {
                    body: alert.description,
                    icon: '/favicon.ico'
                });
            }
        }
        
        function acknowledgeAlert(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (alert) {
                alert.acknowledged = true;
                renderAlerts();
            }
        }
        
        function silenceAlert(alertId) {
            alerts = alerts.filter(a => a.id !== alertId);
            renderAlerts();
        }
        
        function filterAlerts(filter) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥ä½¿ç”¨event.targetï¼Œå› ä¸ºå‚æ•°ä¼ é€’æ–¹å¼ä¸åŒ
            // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°è¢«ç‚¹å‡»çš„æŒ‰é’®
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${filter}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // å®é™…åº”ç”¨ä¸­åº”è¯¥æ ¹æ®filterç­›é€‰å‘Šè­¦
            // è¿™é‡Œåªæ˜¯ç®€å•ç¤ºä¾‹
            renderAlerts();
        }
        
        // ============================================
        // ç³»ç»Ÿç»Ÿè®¡å‡½æ•°
        // ============================================
        function updateSystemStats() {
            // æ›´æ–°æ€»å•†å®¶æ•°
            document.getElementById('totalShops').textContent = shops.length;
            
            // è®¡ç®—åœ¨çº¿å•†å®¶æ•°ï¼ˆæ¨¡æ‹Ÿï¼‰
            const onlineShops = shops.filter(s => s.is_active !== false).length;
            document.getElementById('activeShops').textContent = onlineShops;
            
            // è®¡ç®—æœåŠ¡åˆ°æœŸå•†å®¶æ•°
            const now = new Date();
            const expiredShops = shops.filter(shop => {
                if (!shop.service_end_time) return false;
                const endTime = new Date(shop.service_end_time);
                return now > endTime;
            }).length;
            
            document.getElementById('expiredShops').textContent = expiredShops;
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('lastUpdate').textContent = 
                `æœ€åæ›´æ–°: ${formatTime(new Date().toISOString())}`;
        }
        
        function updateMonitorCards() {
            const stats = window.todayStats || { total: 0, pending: 0, revenue: 0 };
            
            document.getElementById('cardOrders').textContent = stats.total;
            document.getElementById('cardRevenue').textContent = 'Â¥' + stats.revenue.toFixed(2);
            document.getElementById('cardWaiting').textContent = stats.pending;
            
            // è®¡ç®—å¹³å‡ç­‰å¾…æ—¶é—´ï¼ˆæ¨¡æ‹Ÿï¼‰
            const avgWaitTime = stats.pending > 0 ? Math.floor(Math.random() * 10) + 5 : 0;
            document.getElementById('avgWaitTime').textContent = avgWaitTime;
            
            // æ›´æ–°è¶‹åŠ¿ï¼ˆæ¨¡æ‹Ÿï¼‰
            document.getElementById('todayOrders').textContent = stats.total;
            document.getElementById('totalRevenue').textContent = 'Â¥' + stats.revenue.toFixed(2);
        }
        
        // ============================================
        // å·¥å…·å‡½æ•°
        // ============================================
        function getMockShops() {
            return [
                {
                    id: 'default_shop',
                    tenant_id: 'default_shop',
                    name: 'æˆ‘çš„æ‘Šä½',
                    shop_type: 'food',
                    theme_color: '#E63946',
                    is_active: true,
                    service_start_time: new Date().toISOString(),
                    service_end_time: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30å¤©å
                    created_at: new Date().toISOString()
                },
                {
                    id: 'laowang',
                    tenant_id: 'è€ç‹ç…é¥¼',
                    name: 'è€ç‹ç…é¥¼',
                    shop_type: 'food',
                    theme_color: '#FF6B35',
                    is_active: true,
                    service_start_time: null,
                    service_end_time: null,
                    created_at: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'xiaoli',
                    tenant_id: 'å°æçƒ§çƒ¤',
                    name: 'å°æçƒ§çƒ¤',
                    shop_type: 'food',
                    theme_color: '#FF9A00',
                    is_active: true,
                    service_start_time: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 7å¤©å‰å¼€å§‹
                    service_end_time: new Date(Date.now() + 23 * 24 * 60 * 60 * 1000).toISOString(), // 23å¤©åç»“æŸ
                    created_at: new Date(Date.now() - 172800000).toISOString()
                }
            ];
        }
        
        function getAlertIcon(type) {
            switch (type) {
                case 'critical': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                default: return 'bell';
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        function formatDateTime(dateString) {
            if (!dateString) return 'æœªè®¾ç½®';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // 1åˆ†é’Ÿå†…
                return 'åˆšåˆš';
            } else if (diff < 3600000) { // 1å°æ—¶å†…
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) { // 24å°æ—¶å†…
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else {
                return date.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
        
        function formatTimeForInput(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function showRealtimeIndicator(show) {
            const indicator = document.getElementById('realtimeIndicator');
            if (indicator) {
                indicator.style.display = show ? 'flex' : 'none';
            }
        }
        
        // ============================================
        // é¡µé¢æ“ä½œå‡½æ•° - ä¿®å¤äº†è¿›å…¥åå°æŒ‰é’®çš„URLé—®é¢˜
        // ============================================
        function refreshShops() {
            console.log('ğŸ”„ åˆ·æ–°å•†å®¶åˆ—è¡¨...');
            loadAllShops();
        }
        
        function refreshShopData() {
            if (currentShopId) {
                console.log(`ğŸ”„ åˆ·æ–°å•†å®¶æ•°æ®: ${currentShopId}`);
                loadShopData(currentShopId);
            }
        }
        
        // ä¿®å¤è¿›å…¥åå°æŒ‰é’®çš„URLé—®é¢˜
        function openShopAdmin() {
            if (currentShopId) {
                // æ£€æŸ¥æœåŠ¡æ—¶é—´
                const shop = shops.find(s => (s.tenant_id || s.id) === currentShopId);
                if (shop) {
                    const serviceStatus = checkServiceStatus(shop);
                    
                    if (serviceStatus === 'active') {
                        // æœåŠ¡æœ‰æ•ˆï¼Œæ­£å¸¸æ‰“å¼€åå°
                        // ä¿®å¤URLè·¯å¾„é—®é¢˜ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
                        const currentPath = window.location.pathname;
                        const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
                        
                        // æ„å»ºæ­£ç¡®çš„URL
                        let adminUrl;
                        
                        if (window.location.protocol === 'file:') {
                            // æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
                            adminUrl = `admin.html?shop=${currentShopId}`;
                        } else {
                            // ç½‘ç»œç¯å¢ƒï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
                            adminUrl = `admin.html?shop=${currentShopId}`;
                        }
                        
                        console.log('ğŸ”— æ‰“å¼€å•†å®¶åå°:', adminUrl);
                        window.open(adminUrl, '_blank');
                        
                    } else if (serviceStatus === 'expired') {
                        alert('âŒ æœåŠ¡å·²è¿‡æœŸï¼Œæ— æ³•è®¿é—®å•†å®¶åå°\n\nè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ç»­è´¹æœåŠ¡ã€‚');
                    } else if (serviceStatus === 'not_set' || serviceStatus === 'not_started') {
                        alert('â° æœåŠ¡æ—¶é—´æœªè®¾ç½®æˆ–æœªå¼€å§‹\n\nè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜è®¾ç½®æœåŠ¡æ—¶é—´ã€‚');
                    }
                } else {
                    alert('âŒ æœªæ‰¾åˆ°å•†å®¶ä¿¡æ¯');
                }
            } else {
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå•†å®¶');
            }
        }
        
        function startAutoRefresh() {
            // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ•°æ®
            refreshInterval = setInterval(() => {
                if (currentShopId) {
                    loadShopData(currentShopId);
                }
            }, 60000); // 60ç§’
            
            console.log('â° è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”60ç§’');
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopRealtimeSubscriptions();
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        // è¯·æ±‚é€šçŸ¥æƒé™
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // ç»‘å®šè¡¨å•äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // æœåŠ¡æ—¶é—´è¡¨å•äº‹ä»¶
            const startDateInput = document.getElementById('serviceStartDate');
            const startTimeInput = document.getElementById('serviceStartTime');
            const durationInput = document.getElementById('serviceDuration');
            
            if (startDateInput) {
                startDateInput.addEventListener('change', calculateEndDate);
            }
            
            if (startTimeInput) {
                startTimeInput.addEventListener('change', calculateEndDate);
            }
            
            if (durationInput) {
                durationInput.addEventListener('input', calculateEndDate);
                durationInput.addEventListener('change', calculateEndDate);
            }
        });
    </script>
</body>
</html>